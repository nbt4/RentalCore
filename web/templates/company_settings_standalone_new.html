<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}} - RentalCore</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="/static/css/app-new.css" rel="stylesheet">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#1e293b">
</head>
<body class="animate-fade-in">
    <!-- Professional Navigation Bar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-gear-wide-connected"></i> RentalCore
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav me-auto">
                    <a class="nav-link" href="/jobs">
                        <i class="bi bi-briefcase"></i> Jobs
                    </a>
                    <a class="nav-link" href="/devices">
                        <i class="bi bi-cpu"></i> Devices
                    </a>
                    <a class="nav-link" href="/customers">
                        <i class="bi bi-people"></i> Customers
                    </a>
                    <a class="nav-link active" href="/settings/company">
                        <i class="bi bi-building"></i> Company Settings
                    </a>
                </div>
                <div class="navbar-nav">
                    {{if .user}}
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i> {{.user.Username}}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="/logout"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                        </ul>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid">
        <!-- Company Settings Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">
                    <i class="bi bi-building me-2 text-primary"></i>
                    Firmeneinstellungen
                </h1>
                <p class="text-muted mb-0">Verwalten Sie Ihre Unternehmensdaten und Rechnungseinstellungen</p>
            </div>
            <div class="d-none d-md-block">
                <a href="/" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Zurück
                </a>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div id="messageContainer" class="mb-4" style="display: none;">
            <div class="alert" role="alert">
                <div class="d-flex align-items-center">
                    <i class="bi me-2" id="messageIcon"></i>
                    <span id="messageText"></span>
                </div>
            </div>
        </div>

        <!-- Main Form Card -->
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <div class="d-flex align-items-center">
                    <i class="bi bi-building me-2"></i>
                    <h5 class="mb-0">Unternehmensdaten</h5>
                </div>
            </div>
            
            <div class="card-body p-0">
                <form id="companySettingsForm" enctype="multipart/form-data" class="mobile-form-stack">
                    
                    <!-- Basic Company Information -->
                    <div class="border-bottom">
                        <div class="p-4">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                Grunddaten
                            </h6>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="companyName" name="companyName" placeholder="Firmenname" required>
                                        <label for="companyName" class="required">Firmenname</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Address Information -->
                    <div class="border-bottom">
                        <div class="p-4">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-geo-alt me-2"></i>
                                Adresse
                            </h6>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="addressLine1" name="addressLine1" placeholder="Straße und Hausnummer">
                                        <label for="addressLine1">Straße und Hausnummer</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="addressLine2" name="addressLine2" placeholder="Adresszusatz">
                                        <label for="addressLine2">Adresszusatz</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="postalCode" name="postalCode" placeholder="PLZ">
                                        <label for="postalCode">PLZ</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="city" name="city" placeholder="Stadt">
                                        <label for="city">Stadt</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="state" name="state" placeholder="Bundesland">
                                        <label for="state">Bundesland</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="country" name="country" placeholder="Land" value="Deutschland">
                                        <label for="country">Land</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <div class="border-bottom">
                        <div class="p-4">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-telephone me-2"></i>
                                Kontakt
                            </h6>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="tel" class="form-control" id="phone" name="phone" placeholder="Telefon">
                                        <label for="phone">Telefon</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="email" class="form-control" id="email" name="email" placeholder="E-Mail">
                                        <label for="email">E-Mail</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                                        <input type="url" class="form-control" id="website" name="website" placeholder="Website">
                                        <label for="website">Website</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tax Information -->
                    <div class="border-bottom">
                        <div class="p-4">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-receipt me-2"></i>
                                Steuerinformationen
                            </h6>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="taxNumber" name="taxNumber" placeholder="Steuernummer">
                                        <label for="taxNumber">Steuernummer</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="vatNumber" name="vatNumber" placeholder="USt-IdNr.">
                                        <label for="vatNumber">USt-IdNr.</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Banking Information -->
                    <div class="border-bottom">
                        <div class="p-4">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-bank me-2"></i>
                                Bankverbindung
                            </h6>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="bankName" name="bankName" placeholder="Bank">
                                        <label for="bankName">Bank</label>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="iban" name="iban" placeholder="IBAN" data-type="iban">
                                        <label for="iban">IBAN</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="bic" name="bic" placeholder="BIC">
                                        <label for="bic">BIC</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="accountHolder" name="accountHolder" placeholder="Kontoinhaber">
                                        <label for="accountHolder">Kontoinhaber</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Legal Information -->
                    <div class="border-bottom">
                        <div class="p-4">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-shield-check me-2"></i>
                                Rechtliche Angaben
                            </h6>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="ceoName" name="ceoName" placeholder="Geschäftsführer">
                                        <label for="ceoName">Geschäftsführer</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="registerCourt" name="registerCourt" placeholder="Registergericht">
                                        <label for="registerCourt">Registergericht</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="registerNumber" name="registerNumber" placeholder="Handelsregisternummer">
                                        <label for="registerNumber">Handelsregisternummer</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Company Logo -->
                    <div class="border-bottom">
                        <div class="p-4">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-image me-2"></i>
                                Firmenlogo
                            </h6>
                            
                            <div id="logoUpload">
                                <div class="mb-3">
                                    <input class="form-control" type="file" id="logoFile" name="logoFile" accept="image/*">
                                    <div class="form-text">Maximale Dateigröße: 2MB. Unterstützte Formate: JPG, PNG, GIF</div>
                                </div>
                            </div>
                            
                            <div id="logoPreview" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <img id="logoImg" src="" alt="Company Logo" class="img-thumbnail me-3" style="max-height: 80px;">
                                    <div id="logoActions">
                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeLogo()">
                                            <i class="bi bi-trash"></i> Logo entfernen
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Text -->
                    <div>
                        <div class="p-4">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-file-text me-2"></i>
                                Rechnungstexte
                            </h6>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="form-floating">
                                        <textarea class="form-control textarea-auto" id="footerText" name="footerText" placeholder="Fußtext für Rechnungen" style="min-height: 100px;"></textarea>
                                        <label for="footerText">Fußtext für Rechnungen</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                                        <textarea class="form-control textarea-auto" id="paymentTermsText" name="paymentTermsText" placeholder="Zahlungsbedingungen" style="min-height: 100px;"></textarea>
                                        <label for="paymentTermsText">Zahlungsbedingungen</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="mobile-form-actions bg-light border-top">
                        <div class="btn-group w-100" role="group">
                            <button type="submit" class="btn btn-primary btn-lg" id="saveButton">
                                <i class="bi bi-check-lg me-2"></i>
                                Einstellungen speichern
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-lg" onclick="previewCompanyInfo()">
                                <i class="bi bi-eye me-2"></i>
                                Vorschau
                            </button>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <i class="bi bi-keyboard me-1"></i>
                                Tastenkürzel: Strg+S zum Speichern
                            </small>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Mobile Back Button -->
        <div class="d-block d-md-none mt-3">
            <a href="/" class="btn btn-outline-secondary w-100">
                <i class="bi bi-arrow-left me-2"></i> Zurück zum Dashboard
            </a>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">
                        <i class="bi bi-eye me-2"></i>
                        Vorschau Firmeninformationen
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="companyPreview"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize company settings data
    initializeCompanySettings();
    
    // Set up form submission
    const form = document.getElementById('companySettingsForm');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        submitCompanySettings();
    });

    // Keyboard shortcut for save
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            submitCompanySettings();
        }
    });

    // IBAN formatting
    const ibanInput = document.getElementById('iban');
    if (ibanInput) {
        ibanInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').toUpperCase();
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            if (formattedValue !== e.target.value) {
                e.target.value = formattedValue;
            }
        });
    }
});

function showMessage(message, type) {
    const messageContainer = document.getElementById('messageContainer');
    const messageText = document.getElementById('messageText');
    const messageIcon = document.getElementById('messageIcon');
    const alert = messageContainer.querySelector('.alert');
    
    // Reset classes
    alert.className = 'alert';
    messageIcon.className = 'bi me-2';
    
    // Set type-specific classes and icons
    if (type === 'success') {
        alert.classList.add('alert-success');
        messageIcon.classList.add('bi-check-circle-fill');
    } else if (type === 'error') {
        alert.classList.add('alert-danger');
        messageIcon.classList.add('bi-exclamation-triangle-fill');
    } else {
        alert.classList.add('alert-info');
        messageIcon.classList.add('bi-info-circle-fill');
    }
    
    messageText.textContent = message;
    messageContainer.style.display = 'block';
    
    // Auto-hide success messages after 5 seconds
    if (type === 'success') {
        setTimeout(() => {
            messageContainer.style.display = 'none';
        }, 5000);
    }
}

function removeLogo() {
    if (confirm('Sind Sie sicher, dass Sie das Firmenlogo entfernen möchten?')) {
        fetch('/settings/company/logo', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('logoPreview').style.display = 'none';
                document.getElementById('logoUpload').style.display = 'block';
                showMessage('Logo erfolgreich entfernt', 'success');
            } else {
                showMessage('Fehler beim Entfernen des Logos: ' + (data.error || 'Unbekannter Fehler'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Fehler beim Entfernen des Logos', 'error');
        });
    }
}

function submitCompanySettings() {
    const saveButton = document.getElementById('saveButton');
    const originalText = saveButton.innerHTML;
    
    // Show loading state
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Speichern...';
    
    const formData = new FormData(document.getElementById('companySettingsForm'));
    
    // Convert FormData to JSON for non-file fields
    const company = {
        companyName: formData.get('companyName') || '',
        addressLine1: formData.get('addressLine1') || '',
        addressLine2: formData.get('addressLine2') || '',
        city: formData.get('city') || '',
        state: formData.get('state') || '',
        postalCode: formData.get('postalCode') || '',
        country: formData.get('country') || '',
        phone: formData.get('phone') || '',
        email: formData.get('email') || '',
        website: formData.get('website') || '',
        taxNumber: formData.get('taxNumber') || '',
        vatNumber: formData.get('vatNumber') || '',
        bankName: formData.get('bankName') || '',
        iban: formData.get('iban') || '',
        bic: formData.get('bic') || '',
        accountHolder: formData.get('accountHolder') || '',
        ceoName: formData.get('ceoName') || '',
        registerCourt: formData.get('registerCourt') || '',
        registerNumber: formData.get('registerNumber') || '',
        footerText: formData.get('footerText') || '',
        paymentTermsText: formData.get('paymentTermsText') || ''
    };
    
    // Handle logo upload if present
    const logoFile = formData.get('logoFile');
    if (logoFile && logoFile.size > 0) {
        const logoFormData = new FormData();
        logoFormData.append('logo', logoFile);
        
        fetch('/settings/company/logo', {
            method: 'POST',
            body: logoFormData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showMessage('Fehler beim Hochladen des Logos: ' + data.error, 'error');
                saveButton.disabled = false;
                saveButton.innerHTML = originalText;
            } else {
                company.logoPath = data.logoPath;
                updateCompanySettings(company, saveButton, originalText);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Fehler beim Hochladen des Logos', 'error');
            saveButton.disabled = false;
            saveButton.innerHTML = originalText;
        });
    } else {
        updateCompanySettings(company, saveButton, originalText);
    }
}

function updateCompanySettings(company, saveButton, originalText) {
    fetch('/settings/company/api', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(company)
    })
    .then(response => response.json())
    .then(data => {
        saveButton.disabled = false;
        saveButton.innerHTML = originalText;
        
        if (data.error) {
            showMessage('Fehler beim Speichern: ' + data.error, 'error');
        } else {
            showMessage('Firmeneinstellungen erfolgreich gespeichert!', 'success');
            // Scroll to top to show success message
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        saveButton.disabled = false;
        saveButton.innerHTML = originalText;
        showMessage('Fehler beim Speichern der Einstellungen', 'error');
    });
}

function previewCompanyInfo() {
    const company = {
        companyName: document.getElementById('companyName').value,
        addressLine1: document.getElementById('addressLine1').value,
        addressLine2: document.getElementById('addressLine2').value,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value,
        postalCode: document.getElementById('postalCode').value,
        country: document.getElementById('country').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        website: document.getElementById('website').value,
        taxNumber: document.getElementById('taxNumber').value,
        vatNumber: document.getElementById('vatNumber').value,
        bankName: document.getElementById('bankName').value,
        iban: document.getElementById('iban').value,
        bic: document.getElementById('bic').value,
        accountHolder: document.getElementById('accountHolder').value,
        ceoName: document.getElementById('ceoName').value,
        registerCourt: document.getElementById('registerCourt').value,
        registerNumber: document.getElementById('registerNumber').value,
        footerText: document.getElementById('footerText').value,
        paymentTermsText: document.getElementById('paymentTermsText').value
    };
    
    let previewHTML = '<div class="invoice-preview">';
    
    // Logo section
    {{if .company.LogoPath}}
    previewHTML += '<div class="text-center mb-3"><img src="{{.company.LogoPath}}" alt="' + company.companyName + '" style="max-height: 80px;" class="img-fluid"></div>';
    {{end}}
    
    // Company header
    previewHTML += '<div class="text-center mb-4">';
    previewHTML += '<h4 class="mb-1">' + (company.companyName || 'Firmenname') + '</h4>';
    previewHTML += '</div>';
    
    // Address section
    previewHTML += '<div class="row mb-4"><div class="col-md-6">';
    previewHTML += '<h6 class="text-primary mb-2">Adresse</h6>';
    if (company.addressLine1) previewHTML += '<div>' + company.addressLine1 + '</div>';
    if (company.addressLine2) previewHTML += '<div>' + company.addressLine2 + '</div>';
    if (company.postalCode || company.city) {
        previewHTML += '<div>' + (company.postalCode || '') + ' ' + (company.city || '') + '</div>';
    }
    if (company.country) previewHTML += '<div>' + company.country + '</div>';
    previewHTML += '</div>';
    
    // Contact section
    previewHTML += '<div class="col-md-6">';
    previewHTML += '<h6 class="text-primary mb-2">Kontakt</h6>';
    if (company.phone) previewHTML += '<div><strong>Tel:</strong> ' + company.phone + '</div>';
    if (company.email) previewHTML += '<div><strong>E-Mail:</strong> ' + company.email + '</div>';
    if (company.website) previewHTML += '<div><strong>Web:</strong> ' + company.website + '</div>';
    previewHTML += '</div></div>';
    
    // Banking info
    if (company.bankName || company.iban) {
        previewHTML += '<div class="mb-4">';
        previewHTML += '<h6 class="text-primary mb-2">Bankverbindung</h6>';
        if (company.bankName) previewHTML += '<div><strong>Bank:</strong> ' + company.bankName + '</div>';
        if (company.iban) previewHTML += '<div><strong>IBAN:</strong> ' + company.iban + '</div>';
        if (company.bic) previewHTML += '<div><strong>BIC:</strong> ' + company.bic + '</div>';
        if (company.accountHolder) previewHTML += '<div><strong>Kontoinhaber:</strong> ' + company.accountHolder + '</div>';
        previewHTML += '</div>';
    }
    
    // Legal info
    if (company.ceoName || company.registerCourt || company.registerNumber) {
        previewHTML += '<div class="mb-4">';
        previewHTML += '<h6 class="text-primary mb-2">Rechtliche Angaben</h6>';
        if (company.ceoName) previewHTML += '<div><strong>Geschäftsführer:</strong> ' + company.ceoName + '</div>';
        if (company.registerCourt) previewHTML += '<div><strong>Registergericht:</strong> ' + company.registerCourt + '</div>';
        if (company.registerNumber) previewHTML += '<div><strong>Handelsregister:</strong> ' + company.registerNumber + '</div>';
        previewHTML += '</div>';
    }
    
    // Tax information
    if (company.taxNumber || company.vatNumber) {
        previewHTML += '<div class="text-center mt-4 pt-3 border-top">';
        previewHTML += '<small class="text-muted">';
        if (company.taxNumber) previewHTML += '<strong>Steuernummer:</strong> ' + company.taxNumber;
        if (company.taxNumber && company.vatNumber) previewHTML += ' | ';
        if (company.vatNumber) previewHTML += '<strong>USt-IdNr.:</strong> ' + company.vatNumber;
        previewHTML += '</small></div>';
    }
    
    // Footer text
    if (company.footerText) {
        previewHTML += '<div class="text-center mt-3 pt-2 border-top">';
        previewHTML += '<small class="text-muted"><em>' + company.footerText + '</em></small>';
        previewHTML += '</div>';
    }
    
    previewHTML += '</div>';
    
    document.getElementById('companyPreview').innerHTML = previewHTML;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}

// Load company settings when the form is ready
function initializeCompanySettings() {
    loadCompanySettings();
}

function loadCompanySettings() {
    fetch('/settings/company/api', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.company) {
            populateForm(data.company);
        } else {
            console.error('Failed to load company settings:', data.error);
        }
    })
    .catch(error => {
        console.error('Error loading company settings:', error);
    });
}

function populateForm(company) {
    // Basic company information
    setFieldValue('companyName', company.companyName);
    setFieldValue('addressLine1', company.addressLine1);
    setFieldValue('addressLine2', company.addressLine2);
    setFieldValue('city', company.city);
    setFieldValue('state', company.state);
    setFieldValue('postalCode', company.postalCode);
    setFieldValue('country', company.country);
    setFieldValue('phone', company.phone);
    setFieldValue('email', company.email);
    setFieldValue('website', company.website);
    setFieldValue('taxNumber', company.taxNumber);
    setFieldValue('vatNumber', company.vatNumber);
    
    // Banking information
    setFieldValue('bankName', company.bankName);
    setFieldValue('iban', company.iban);
    setFieldValue('bic', company.bic);
    setFieldValue('accountHolder', company.accountHolder);
    
    // Legal information
    setFieldValue('ceoName', company.ceoName);
    setFieldValue('registerCourt', company.registerCourt);
    setFieldValue('registerNumber', company.registerNumber);
    
    // Invoice text fields
    setFieldValue('footerText', company.footerText);
    setFieldValue('paymentTermsText', company.paymentTermsText);
    
    // Update logo display if exists
    if (company.logoPath) {
        const logoPreview = document.getElementById('logoPreview');
        const logoImg = document.getElementById('logoImg');
        const logoActions = document.getElementById('logoActions');
        const logoUpload = document.getElementById('logoUpload');
        
        if (logoPreview && logoImg) {
            logoImg.src = company.logoPath;
            logoPreview.style.display = 'block';
        }
        if (logoActions) logoActions.style.display = 'block';
        if (logoUpload) logoUpload.style.display = 'none';
    }
}

function setFieldValue(fieldId, value) {
    const field = document.getElementById(fieldId);
    if (field && value !== null && value !== undefined) {
        field.value = value;
    }
}
</script>

<style>
.invoice-preview {
    background: white;
    color: #333;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.invoice-preview h4, .invoice-preview h6 {
    color: #333;
}

.form-floating textarea.textarea-auto {
    min-height: 100px;
    resize: vertical;
}

.mobile-form-actions {
    position: sticky;
    bottom: 0;
    z-index: 100;
    margin: 0 -1rem -1rem;
    padding: 1rem;
}

@media (max-width: 767px) {
    .card-body {
        padding: 0;
    }
    
    .mobile-form-actions .btn-group {
        flex-direction: column;
    }
    
    .mobile-form-actions .btn {
        border-radius: 0.375rem !important;
        margin-bottom: 0.5rem;
    }
    
    .mobile-form-actions .btn:last-child {
        margin-bottom: 0;
    }
}

/* Required field indicator */
.form-label.required::after {
    content: " *";
    color: #dc3545;
}

/* Form validation styles */
.form-control:valid {
    border-color: #28a745;
}

.form-control:invalid {
    border-color: #dc3545;
}

/* IBAN formatting */
.form-control[data-type="iban"] {
    text-transform: uppercase;
    letter-spacing: 1px;
}
</style>

</body>
</html>