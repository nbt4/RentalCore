<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}} - RentalCore</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/app.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&family=Arial:wght@400;700&family=Times+New+Roman:wght@400;700&family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .designer-container {
            min-height: 100vh;
            background: var(--gradient-primary);
        }

        .control-panel {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-primary);
            box-shadow: var(--shadow-lg);
            height: calc(100vh - 120px);
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }

        .control-panel::-webkit-scrollbar {
            width: 6px;
        }

        .control-panel::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 3px;
        }

        .control-panel::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: 3px;
        }

        .preview-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-primary);
            padding: var(--spacing-lg);
            height: calc(100vh - 120px);
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            position: relative;
            box-shadow: var(--shadow-lg);
        }

        .a4-preview {
            width: 210mm;
            min-height: 297mm;
            background: white;
            color: #000;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-2xl);
            position: relative;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            transform: scale(0.5);
            transform-origin: top center;
            margin: var(--spacing-lg) auto;
            border: 2px solid #e9ecef;
            page-break-inside: avoid;
        }
        
        @media print {
            .a4-preview {
                width: 210mm;
                min-height: 297mm;
                transform: scale(1);
                margin: 0;
                box-shadow: none;
                border: none;
            }
        }

        .preview-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: var(--spacing-sm);
            z-index: 1000;
        }

        .zoom-control {
            background: var(--bg-glass);
            color: var(--text-bright);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            font-size: 12px;
            transition: var(--transition-fast);
        }

        .zoom-control:hover {
            background: var(--bg-hover);
            border-color: var(--accent-color);
        }

        .element-editor {
            position: absolute;
            background: rgba(59, 130, 246, 0.1);
            border: 2px dashed var(--accent-color);
            border-radius: var(--radius-sm);
            cursor: move;
            min-width: 50px;
            min-height: 20px;
            transition: var(--transition-fast);
            user-select: none;
        }

        .element-editor:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: scale(1.02);
        }

        .element-editor.selected {
            border-color: var(--warning-color);
            background: rgba(245, 158, 11, 0.1);
            box-shadow: var(--shadow-glow);
        }

        .element-editor .resize-handle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--accent-color);
            border-radius: 50%;
            border: 1px solid white;
        }

        .element-editor .resize-handle.nw { top: -4px; left: -4px; cursor: nw-resize; }
        .element-editor .resize-handle.ne { top: -4px; right: -4px; cursor: ne-resize; }
        .element-editor .resize-handle.sw { bottom: -4px; left: -4px; cursor: sw-resize; }
        .element-editor .resize-handle.se { bottom: -4px; right: -4px; cursor: se-resize; }

        .template-preset {
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            cursor: pointer;
            transition: var(--transition-normal);
            background: var(--bg-glass);
        }

        .template-preset:hover {
            border-color: var(--accent-color);
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
            box-shadow: var(--shadow-accent);
        }

        .template-preset.active {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
            box-shadow: var(--shadow-md);
        }

        .template-preview-thumb {
            width: 100%;
            height: 120px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }

        .font-preview {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .font-preview:hover {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.1);
        }

        .element-toolbar {
            position: absolute;
            top: -40px;
            left: 0;
            display: flex;
            gap: 5px;
            background: rgba(0,0,0,0.8);
            padding: 5px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .element-editor:hover .element-toolbar {
            opacity: 1;
        }

        .toolbar-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 3px;
            padding: 3px 6px;
            font-size: 10px;
            cursor: pointer;
        }

        .toolbar-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .form-control, .form-select {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
            color: var(--text-primary) !important;
            border-radius: var(--radius-sm);
        }

        .form-control:focus, .form-select:focus {
            background: var(--bg-hover) !important;
            border-color: var(--accent-color) !important;
            box-shadow: var(--shadow-glow) !important;
            color: var(--text-primary) !important;
        }

        .btn-primary {
            background: var(--gradient-accent);
            border-color: var(--accent-color);
            border-radius: var(--radius-sm);
        }

        .btn-success {
            background: var(--gradient-success);
            border-color: var(--success-color);
            border-radius: var(--radius-sm);
        }

        .btn-outline-primary {
            color: var(--accent-color);
            border-color: var(--accent-color);
            border-radius: var(--radius-sm);
        }

        .btn-outline-primary:hover {
            background: var(--gradient-accent);
            border-color: var(--accent-color);
        }

        .card {
            background: var(--bg-card) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: var(--radius-md) !important;
            box-shadow: var(--shadow-md);
        }

        .card-header {
            background: var(--bg-glass) !important;
            border-bottom: 1px solid var(--border-primary) !important;
            border-radius: var(--radius-md) var(--radius-md) 0 0 !important;
        }

        .nav-pills .nav-link {
            color: var(--text-secondary);
            background: transparent;
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
        }

        .nav-pills .nav-link.active {
            background: var(--gradient-accent);
            color: var(--text-bright);
        }

        .nav-pills .nav-link:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .accordion-button {
            background: var(--bg-glass) !important;
            color: var(--text-primary) !important;
            border: none !important;
            border-radius: var(--radius-sm) !important;
        }

        .accordion-button:not(.collapsed) {
            background: rgba(59, 130, 246, 0.1) !important;
            color: var(--text-primary) !important;
            box-shadow: var(--shadow-sm);
        }

        .accordion-body {
            background: var(--bg-secondary) !important;
            border-top: 1px solid var(--border-primary) !important;
            border-radius: 0 0 var(--radius-sm) var(--radius-sm) !important;
        }

        .logo-upload-area {
            border: 2px dashed var(--border-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-xl);
            text-align: center;
            cursor: pointer;
            transition: var(--transition-normal);
            background: var(--bg-glass);
        }

        .logo-upload-area:hover {
            border-color: var(--accent-color);
            background: rgba(59, 130, 246, 0.05);
            box-shadow: var(--shadow-sm);
        }

        .logo-upload-area.dragover {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
            box-shadow: var(--shadow-md);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-gear-wide-connected"></i> RentalCore
            </a>
            <div class="navbar-nav">
                <a class="nav-link" href="/jobs">Jobs</a>
                <a class="nav-link" href="/devices">Devices</a>
                <a class="nav-link" href="/customers">Customers</a>
                <a class="nav-link" href="/invoices">Invoices</a>
                <a class="nav-link active" href="/invoice-templates">Templates</a>
                {{if .user}}
                <a class="nav-link" href="/logout">Logout ({{.user.Username}})</a>
                {{end}}
            </div>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-light me-2" onclick="saveTemplate()">
                    <i class="bi bi-save"></i> Save Template
                </button>
                <button class="btn btn-outline-light me-2" onclick="previewTemplate()">
                    <i class="bi bi-eye"></i> Preview
                </button>
                <button class="btn btn-outline-light me-2" onclick="testNavigation()">
                    <i class="bi bi-bug"></i> Test Route
                </button>
                <a class="btn btn-outline-light me-2" href="/invoice-templates" target="_blank">
                    <i class="bi bi-list"></i> View Templates (New Tab)
                </a>
                <button class="btn btn-outline-light" onclick="navigateToTemplates()">
                    <i class="bi bi-arrow-left"></i> Back to Templates
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid p-4">
        <div class="row">
            <!-- Control Panel -->
            <div class="col-md-4">
                <div class="control-panel p-3">
                    <!-- Template Info -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-info-circle"></i> Template Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Template Name</label>
                                <input type="text" id="templateName" class="form-control" 
                                       value="{{.template.Name}}" placeholder="Enter template name">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea id="templateDescription" class="form-control" rows="2" 
                                          placeholder="Template description">{{if .template.Description}}{{.template.Description}}{{end}}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Tabs -->
                    <ul class="nav nav-pills mb-3" id="designerTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="presets-tab" data-bs-toggle="pill" data-bs-target="#presets" type="button">Presets</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="design-tab" data-bs-toggle="pill" data-bs-target="#design" type="button">Design</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="elements-tab" data-bs-toggle="pill" data-bs-target="#elements" type="button">Elements</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="designerTabContent">
                        <!-- Template Presets Tab -->
                        <div class="tab-pane fade show active" id="presets" role="tabpanel">
                            <h6 class="mb-3"><i class="bi bi-collection"></i> Template Presets</h6>
                            
                            <!-- German Standard DIN 5008 -->
                            <div class="template-preset" onclick="loadTemplate('german-din')">
                                <div class="template-preview-thumb">
                                    <div style="position: absolute; top: 5px; right: 5px; font-size: 8px; font-weight: bold;">Company Name</div>
                                    <div style="position: absolute; top: 30px; left: 5px; border: 1px solid #000; width: 60px; height: 25px; font-size: 6px; padding: 2px;">Customer Address</div>
                                    <div style="position: absolute; top: 65px; left: 5px; font-size: 10px; font-weight: bold;">RECHNUNG</div>
                                    <div style="position: absolute; bottom: 20px; left: 5px; right: 5px; border-top: 1px solid #000; font-size: 6px; padding-top: 2px;">Items table</div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>German Standard (DIN 5008)</strong>
                                        <small class="d-block text-muted">Professional German invoice layout</small>
                                    </div>
                                    <i class="bi bi-check-circle text-success" style="display: none;"></i>
                                </div>
                            </div>

                            <!-- Modern Corporate -->
                            <div class="template-preset" onclick="loadTemplate('modern-corporate')">
                                <div class="template-preview-thumb">
                                    <div style="position: absolute; top: 5px; left: 5px; width: 15px; height: 15px; background: #007bff; border-radius: 2px;"></div>
                                    <div style="position: absolute; top: 5px; right: 5px; font-size: 8px; color: #007bff; font-weight: bold;">INVOICE</div>
                                    <div style="position: absolute; top: 30px; left: 5px; background: #f8f9fa; width: 60px; height: 20px; font-size: 6px; padding: 2px;">Bill To</div>
                                    <div style="position: absolute; bottom: 10px; right: 5px; background: #007bff; color: white; width: 30px; height: 15px; font-size: 6px; text-align: center; line-height: 15px;">Total</div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>Modern Corporate</strong>
                                        <small class="d-block text-muted">Clean, professional design</small>
                                    </div>
                                    <i class="bi bi-check-circle text-success" style="display: none;"></i>
                                </div>
                            </div>

                            <!-- Classic Business -->
                            <div class="template-preset" onclick="loadTemplate('classic-business')">
                                <div class="template-preview-thumb">
                                    <div style="position: absolute; top: 5px; left: 50%; transform: translateX(-50%); font-size: 10px; font-weight: bold; text-decoration: underline;">INVOICE</div>
                                    <div style="position: absolute; top: 25px; left: 5px; right: 5px; border-bottom: 2px solid #000; height: 1px;"></div>
                                    <div style="position: absolute; top: 35px; left: 5px; font-size: 6px;">Invoice #:</div>
                                    <div style="position: absolute; top: 45px; left: 5px; font-size: 6px;">Date:</div>
                                    <div style="position: absolute; bottom: 20px; left: 5px; right: 5px; border: 1px solid #000; height: 30px;"></div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>Classic Business</strong>
                                        <small class="d-block text-muted">Traditional invoice format</small>
                                    </div>
                                    <i class="bi bi-check-circle text-success" style="display: none;"></i>
                                </div>
                            </div>

                            <!-- Minimalist -->
                            <div class="template-preset" onclick="loadTemplate('minimalist')">
                                <div class="template-preview-thumb">
                                    <div style="position: absolute; top: 10px; left: 5px; font-size: 8px; color: #666;">Company</div>
                                    <div style="position: absolute; top: 30px; right: 5px; font-size: 12px; font-weight: bold; color: #333;">Invoice</div>
                                    <div style="position: absolute; top: 60px; left: 5px; right: 5px; height: 1px; background: #eee;"></div>
                                    <div style="position: absolute; bottom: 30px; left: 5px; right: 5px; height: 1px; background: #eee;"></div>
                                    <div style="position: absolute; bottom: 10px; right: 5px; font-size: 8px; font-weight: bold;">Total: €XXX</div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>Minimalist</strong>
                                        <small class="d-block text-muted">Clean and simple</small>
                                    </div>
                                    <i class="bi bi-check-circle text-success" style="display: none;"></i>
                                </div>
                            </div>

                            <!-- Creative Colored -->
                            <div class="template-preset" onclick="loadTemplate('creative-colored')">
                                <div class="template-preview-thumb">
                                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 15px; background: linear-gradient(45deg, #667eea, #764ba2);"></div>
                                    <div style="position: absolute; top: 20px; left: 5px; font-size: 8px; color: #667eea; font-weight: bold;">INVOICE</div>
                                    <div style="position: absolute; top: 35px; left: 5px; width: 50px; height: 20px; background: rgba(102, 126, 234, 0.1); font-size: 6px; padding: 2px;">Customer</div>
                                    <div style="position: absolute; bottom: 15px; right: 5px; background: #667eea; color: white; width: 35px; height: 12px; font-size: 6px; text-align: center; line-height: 12px; border-radius: 2px;">TOTAL</div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>Creative Colored</strong>
                                        <small class="d-block text-muted">Modern with color accents</small>
                                    </div>
                                    <i class="bi bi-check-circle text-success" style="display: none;"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Design Settings Tab -->
                        <div class="tab-pane fade" id="design" role="tabpanel">
                            <div class="accordion" id="designAccordion">
                                <!-- Logo Upload -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#logoSection">
                                            <i class="bi bi-image me-2"></i> Logo & Branding
                                        </button>
                                    </h2>
                                    <div id="logoSection" class="accordion-collapse collapse show">
                                        <div class="accordion-body">
                                            <div class="logo-upload-area mb-3" onclick="document.getElementById('logoUpload').click()">
                                                <i class="bi bi-cloud-upload fs-2 mb-2 d-block"></i>
                                                <p class="mb-0">Click or drag to upload logo</p>
                                                <small class="text-muted">Supports PNG, JPG, SVG</small>
                                            </div>
                                            <input type="file" id="logoUpload" accept="image/*" style="display: none;">
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Logo Position</label>
                                                <select class="form-select" id="logoPosition">
                                                    <option value="top-left">Top Left</option>
                                                    <option value="top-center">Top Center</option>
                                                    <option value="top-right">Top Right</option>
                                                    <option value="custom">Custom Position</option>
                                                </select>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Logo Size</label>
                                                <select class="form-select" id="logoSize">
                                                    <option value="small">Small (40px)</option>
                                                    <option value="medium" selected>Medium (60px)</option>
                                                    <option value="large">Large (80px)</option>
                                                    <option value="custom">Custom Size</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Typography -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#typographySection">
                                            <i class="bi bi-fonts me-2"></i> Typography
                                        </button>
                                    </h2>
                                    <div id="typographySection" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <div class="mb-3">
                                                <label class="form-label">Primary Font</label>
                                                <select class="form-select" id="primaryFont">
                                                    <option value="Arial">Arial</option>
                                                    <option value="Times New Roman">Times New Roman</option>
                                                    <option value="Inter">Inter</option>
                                                    <option value="Roboto">Roboto</option>
                                                    <option value="Ubuntu">Ubuntu</option>
                                                    <option value="Helvetica">Helvetica</option>
                                                </select>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Header Font Size</label>
                                                <input type="range" class="form-range" id="headerFontSize" min="14" max="32" value="24">
                                                <small class="text-muted">Current: <span id="headerFontSizeValue">24px</span></small>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Body Font Size</label>
                                                <input type="range" class="form-range" id="bodyFontSize" min="8" max="16" value="12">
                                                <small class="text-muted">Current: <span id="bodyFontSizeValue">12px</span></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Colors -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#colorsSection">
                                            <i class="bi bi-palette me-2"></i> Colors
                                        </button>
                                    </h2>
                                    <div id="colorsSection" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <div class="row">
                                                <div class="col-6">
                                                    <label class="form-label">Primary Color</label>
                                                    <input type="color" class="color-picker" id="primaryColor" value="#2563eb">
                                                </div>
                                                <div class="col-6">
                                                    <label class="form-label">Accent Color</label>
                                                    <input type="color" class="color-picker" id="accentColor" value="#64748b">
                                                </div>
                                                <div class="col-6">
                                                    <label class="form-label">Text Color</label>
                                                    <input type="color" class="color-picker" id="textColor" value="#000000">
                                                </div>
                                                <div class="col-6">
                                                    <label class="form-label">Background</label>
                                                    <input type="color" class="color-picker" id="backgroundColor" value="#ffffff">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Layout -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#layoutSection">
                                            <i class="bi bi-grid me-2"></i> Layout
                                        </button>
                                    </h2>
                                    <div id="layoutSection" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            <div class="mb-3">
                                                <label class="form-label">Page Margins</label>
                                                <input type="range" class="form-range" id="pageMargins" min="10" max="40" value="20">
                                                <small class="text-muted">Current: <span id="pageMarginsValue">20mm</span></small>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Element Spacing</label>
                                                <input type="range" class="form-range" id="elementSpacing" min="5" max="30" value="15">
                                                <small class="text-muted">Current: <span id="elementSpacingValue">15px</span></small>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Border Style</label>
                                                <select class="form-select" id="borderStyle">
                                                    <option value="none">No Borders</option>
                                                    <option value="solid">Solid Lines</option>
                                                    <option value="dashed">Dashed Lines</option>
                                                    <option value="dotted">Dotted Lines</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Elements Tab -->
                        <div class="tab-pane fade" id="elements" role="tabpanel">
                            <h6 class="mb-3"><i class="bi bi-puzzle"></i> Add Elements</h6>
                            
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="addElement('text')">
                                    <i class="bi bi-type"></i> Add Text
                                </button>
                                <button class="btn btn-outline-primary" onclick="addElement('table')">
                                    <i class="bi bi-table"></i> Add Table
                                </button>
                                <button class="btn btn-outline-primary" onclick="addElement('line')">
                                    <i class="bi bi-hr"></i> Add Line
                                </button>
                                <button class="btn btn-outline-primary" onclick="addElement('image')">
                                    <i class="bi bi-image"></i> Add Image
                                </button>
                                <button class="btn btn-outline-primary" onclick="addElement('qr-code')">
                                    <i class="bi bi-qr-code"></i> Add QR Code
                                </button>
                                <button class="btn btn-outline-primary" onclick="addElement('barcode')">
                                    <i class="bi bi-upc"></i> Add Barcode
                                </button>
                            </div>

                            <hr class="my-4">

                            <div id="elementProperties" style="display: none;">
                                <h6><i class="bi bi-gear"></i> Element Properties</h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">Position X</label>
                                    <input type="number" class="form-control" id="elementX" placeholder="X coordinate">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Position Y</label>
                                    <input type="number" class="form-control" id="elementY" placeholder="Y coordinate">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Width</label>
                                    <input type="number" class="form-control" id="elementWidth" placeholder="Width in px">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Height</label>
                                    <input type="number" class="form-control" id="elementHeight" placeholder="Height in px">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Font Size</label>
                                    <input type="number" class="form-control" id="elementFontSize" placeholder="Font size in px">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Text Color</label>
                                    <input type="color" class="color-picker" id="elementTextColor" value="#000000">
                                </div>

                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" onclick="applyElementProperties()">
                                        <i class="bi bi-check"></i> Apply Changes
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteSelectedElement()">
                                        <i class="bi bi-trash"></i> Delete Element
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preview Area -->
            <div class="col-md-8">
                <div class="preview-container">
                    <div class="preview-controls">
                        <button class="zoom-control" onclick="adjustZoom(0.5)">50%</button>
                        <button class="zoom-control" onclick="adjustZoom(0.7)">70%</button>
                        <button class="zoom-control" onclick="adjustZoom(1.0)">100%</button>
                        <button class="zoom-control" onclick="toggleGrid()">
                            <i class="bi bi-grid-3x3"></i>
                        </button>
                    </div>
                    
                    <div class="a4-preview" id="invoicePreview">
                        <div id="templateContent">
                            <div style="text-align: center; margin-top: 100px; color: #666;">
                                <i class="bi bi-file-earmark-text" style="font-size: 48px;"></i>
                                <p class="mt-3">Select a template preset to start designing</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        const templateID = {{if .template.TemplateID}}{{.template.TemplateID}}{{else}}0{{end}};
        const isEdit = {{.isEdit}};
        let selectedElement = null;
        let dragElement = null;
        let dragOffset = { x: 0, y: 0 };
        let currentTemplate = '';
        let currentZoom = 0.7;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadSampleData();
            
            // Auto-load German template for new templates or load existing template for editing
            if (!isEdit) {
                setTimeout(() => loadTemplate('german-din'), 500);
            } else {
                // Load existing template content for editing
                setTimeout(() => loadExistingTemplate(), 500);
            }
        });

        function loadExistingTemplate() {
            const existingHtml = `{{if .template.HTMLTemplate}}{{.template.HTMLTemplate}}{{end}}`;
            if (existingHtml) {
                const templateContent = document.getElementById('templateContent');
                templateContent.innerHTML = existingHtml;
                updatePreview();
            } else {
                // Fallback to loading a default template
                loadTemplate('german-din');
            }
        }

        function initializeEventListeners() {
            // Logo upload
            document.getElementById('logoUpload').addEventListener('change', handleLogoUpload);
            
            // Font size sliders
            document.getElementById('headerFontSize').addEventListener('input', function() {
                document.getElementById('headerFontSizeValue').textContent = this.value + 'px';
                updatePreview();
            });
            
            document.getElementById('bodyFontSize').addEventListener('input', function() {
                document.getElementById('bodyFontSizeValue').textContent = this.value + 'px';
                updatePreview();
            });
            
            // Layout sliders
            document.getElementById('pageMargins').addEventListener('input', function() {
                document.getElementById('pageMarginsValue').textContent = this.value + 'mm';
                updatePreview();
            });
            
            document.getElementById('elementSpacing').addEventListener('input', function() {
                document.getElementById('elementSpacingValue').textContent = this.value + 'px';
                updatePreview();
            });
            
            // Color pickers
            ['primaryColor', 'accentColor', 'textColor', 'backgroundColor'].forEach(id => {
                document.getElementById(id).addEventListener('change', updatePreview);
            });
            
            // Style selectors
            ['primaryFont', 'borderStyle', 'logoPosition', 'logoSize'].forEach(id => {
                document.getElementById(id).addEventListener('change', updatePreview);
            });
        }

        function loadSampleData() {
            // This will be replaced with actual data in real implementation
            window.sampleData = {
                company: {
                    CompanyName: "Musterfirma GmbH",
                    AddressLine1: "Musterstraße 123",
                    PostalCode: "12345", 
                    City: "Musterstadt",
                    Phone: "+49 123 456789",
                    Email: "info@musterfirma.de",
                    TaxNumber: "123/456/78901",
                    VATNumber: "DE123456789"
                },
                customer: {
                    GetDisplayName: "Max Mustermann",
                    AddressLine1: "Kundenstraße 456",
                    PostalCode: "54321",
                    City: "Kundenstadt",
                    CustomerID: "KD-001"
                },
                invoice: {
                    InvoiceNumber: "RE-2024-001",
                    IssueDate: "2024-06-17",
                    DueDate: "2024-07-01",
                    Subtotal: 100.00,
                    TaxAmount: 19.00,
                    TotalAmount: 119.00,
                    LineItems: [
                        { Description: "Beispiel Artikel 1", Quantity: 1, UnitPrice: 100.00, TotalPrice: 100.00 }
                    ]
                }
            };
        }

        function loadTemplate(templateType) {
            currentTemplate = templateType;
            
            // Update preset selection visual
            document.querySelectorAll('.template-preset').forEach(preset => {
                preset.classList.remove('active');
                preset.querySelector('.bi-check-circle').style.display = 'none';
            });
            
            event.currentTarget.classList.add('active');
            event.currentTarget.querySelector('.bi-check-circle').style.display = 'block';
            
            let content = '';
            
            switch(templateType) {
                case 'german-din':
                    content = getGermanDINTemplate();
                    break;
                case 'modern-corporate':
                    content = getModernCorporateTemplate();
                    break;
                case 'classic-business':
                    content = getClassicBusinessTemplate();
                    break;
                case 'minimalist':
                    content = getMinimalistTemplate();
                    break;
                case 'creative-colored':
                    content = getCreativeColoredTemplate();
                    break;
                default:
                    content = getGermanDINTemplate();
            }
            
            document.getElementById('templateContent').innerHTML = content;
            addInteractivityToElements();
            updatePreview();
        }

        function getGermanDINTemplate() {
            return `
                <div style="padding: 20mm; font-family: Arial, sans-serif; font-size: 12px;">
                    <!-- Company Header -->
                    <div style="text-align: right; margin-bottom: 30px;">
                        <div style="font-weight: bold; font-size: 16px;">[COMPANY_NAME]</div>
                        <div>[COMPANY_ADDRESS]</div>
                        <div>[COMPANY_POSTAL] [COMPANY_CITY]</div>
                        <div>Tel: [COMPANY_PHONE]</div>
                        <div>E-Mail: [COMPANY_EMAIL]</div>
                    </div>

                    <!-- Sender Address Line -->
                    <div style="font-size: 8px; margin-bottom: 10px; border-bottom: 1px solid #000; padding-bottom: 5px;">
                        [COMPANY_NAME], [COMPANY_ADDRESS], [COMPANY_POSTAL] [COMPANY_CITY]
                    </div>

                    <!-- Customer Address -->
                    <div style="margin-bottom: 30px;">
                        <div style="font-weight: bold;">[CUSTOMER_NAME]</div>
                        <div>[CUSTOMER_ADDRESS]</div>
                        <div>[CUSTOMER_POSTAL] [CUSTOMER_CITY]</div>
                    </div>

                    <!-- Invoice Header -->
                    <h1 style="font-size: 24px; font-weight: bold; margin-bottom: 20px;">RECHNUNG</h1>

                    <!-- Invoice Details -->
                    <table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;">
                        <tr>
                            <td style="width: 30%; padding: 5px 0;">Rechnungsnummer:</td>
                            <td style="font-weight: bold;">[INVOICE_NUMBER]</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">Rechnungsdatum:</td>
                            <td>[INVOICE_DATE]</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">Fälligkeitsdatum:</td>
                            <td>[DUE_DATE]</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px 0;">Kundennummer:</td>
                            <td>[CUSTOMER_ID]</td>
                        </tr>
                    </table>

                    <!-- Line Items -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="border: 1px solid #000; padding: 8px; text-align: left;">Pos.</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: left;">Beschreibung</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: center;">Menge</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: right;">Einzelpreis</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: right;">Gesamtpreis</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="border: 1px solid #000; padding: 8px;">1</td>
                                <td style="border: 1px solid #000; padding: 8px;">[SAMPLE_ITEM]</td>
                                <td style="border: 1px solid #000; padding: 8px; text-align: center;">1</td>
                                <td style="border: 1px solid #000; padding: 8px; text-align: right;">100,00 €</td>
                                <td style="border: 1px solid #000; padding: 8px; text-align: right;">100,00 €</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Totals -->
                    <div style="text-align: right; margin-bottom: 30px;">
                        <table style="width: 200px; margin-left: auto; border-collapse: collapse;">
                            <tr>
                                <td style="padding: 5px 10px; border-bottom: 1px solid #ddd;">Nettobetrag:</td>
                                <td style="text-align: right; padding: 5px 10px; border-bottom: 1px solid #ddd;">[SUBTOTAL] €</td>
                            </tr>
                            <tr>
                                <td style="padding: 5px 10px; border-bottom: 1px solid #ddd;">MwSt. (19%):</td>
                                <td style="text-align: right; padding: 5px 10px; border-bottom: 1px solid #ddd;">[TAX_AMOUNT] €</td>
                            </tr>
                            <tr style="font-weight: bold; border-top: 2px solid #000;">
                                <td style="padding: 8px 10px;">Gesamtbetrag:</td>
                                <td style="text-align: right; padding: 8px 10px;">[TOTAL_AMOUNT] €</td>
                            </tr>
                        </table>
                    </div>

                    <!-- Footer -->
                    <div style="font-size: 10px; margin-top: 40px; border-top: 1px solid #ddd; padding-top: 20px;">
                        <div style="text-align: center;">
                            <div>Steuernummer: [TAX_NUMBER] | USt-IdNr.: [VAT_NUMBER]</div>
                            <div style="margin-top: 10px;">
                                Zahlungsziel: 14 Tage netto | Bankverbindung: IBAN DE12 3456 7890 1234 5678 90
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getModernCorporateTemplate() {
            return `
                <div style="padding: 20mm; font-family: Inter, sans-serif; font-size: 12px;">
                    <!-- Header with Logo -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #007bff; padding-bottom: 20px;">
                        <div>
                            <div style="width: 60px; height: 60px; background: #007bff; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px;">LOGO</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; font-size: 18px; color: #007bff;">[COMPANY_NAME]</div>
                            <div>[COMPANY_ADDRESS]</div>
                            <div>[COMPANY_POSTAL] [COMPANY_CITY]</div>
                            <div>[COMPANY_PHONE] | [COMPANY_EMAIL]</div>
                        </div>
                    </div>

                    <!-- Customer Section -->
                    <div style="background: #f8f9fa; padding: 20px; margin-bottom: 30px; border-radius: 8px;">
                        <div style="font-weight: bold; color: #007bff; margin-bottom: 10px;">Bill To:</div>
                        <div style="font-weight: bold;">[CUSTOMER_NAME]</div>
                        <div>[CUSTOMER_ADDRESS]</div>
                        <div>[CUSTOMER_POSTAL] [CUSTOMER_CITY]</div>
                    </div>

                    <!-- Invoice Title -->
                    <h1 style="color: #007bff; font-size: 28px; margin-bottom: 30px;">INVOICE</h1>

                    <!-- Invoice Details -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; width: 48%;">
                            <div style="margin-bottom: 8px;"><strong>Invoice #:</strong> [INVOICE_NUMBER]</div>
                            <div style="margin-bottom: 8px;"><strong>Date:</strong> [INVOICE_DATE]</div>
                            <div><strong>Due Date:</strong> [DUE_DATE]</div>
                        </div>
                        <div style="background: #007bff; color: white; padding: 15px; border-radius: 8px; width: 48%; text-align: center;">
                            <div style="font-size: 14px; margin-bottom: 5px;">Amount Due</div>
                            <div style="font-size: 24px; font-weight: bold;">€[TOTAL_AMOUNT]</div>
                        </div>
                    </div>

                    <!-- Line Items -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: #007bff; color: white;">
                                <th style="padding: 15px; text-align: left;">Description</th>
                                <th style="padding: 15px; text-align: center;">Qty</th>
                                <th style="padding: 15px; text-align: right;">Price</th>
                                <th style="padding: 15px; text-align: right;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: #f8f9fa;">
                                <td style="padding: 15px;">[SAMPLE_ITEM]</td>
                                <td style="padding: 15px; text-align: center;">1</td>
                                <td style="padding: 15px; text-align: right;">€100.00</td>
                                <td style="padding: 15px; text-align: right; font-weight: bold;">€100.00</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Footer -->
                    <div style="text-align: center; margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 10px; color: #666;">
                        <div>Tax ID: [TAX_NUMBER] | VAT ID: [VAT_NUMBER]</div>
                        <div style="margin-top: 10px;">Payment Terms: Net 14 days | Bank: IBAN DE12 3456 7890 1234 5678 90</div>
                    </div>
                </div>
            `;
        }

        function getClassicBusinessTemplate() {
            return `
                <div style="padding: 25mm; font-family: 'Times New Roman', serif; font-size: 12px;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 40px;">
                        <h1 style="font-size: 28px; font-weight: bold; text-decoration: underline; margin-bottom: 20px;">INVOICE</h1>
                        <div style="border-bottom: 2px solid #000; width: 100%; margin-bottom: 20px;"></div>
                    </div>

                    <!-- Company and Customer Info -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                        <div style="width: 45%;">
                            <div style="font-weight: bold; font-size: 14px; margin-bottom: 10px;">From:</div>
                            <div style="font-weight: bold;">[COMPANY_NAME]</div>
                            <div>[COMPANY_ADDRESS]</div>
                            <div>[COMPANY_POSTAL] [COMPANY_CITY]</div>
                            <div>Phone: [COMPANY_PHONE]</div>
                            <div>Email: [COMPANY_EMAIL]</div>
                        </div>
                        <div style="width: 45%;">
                            <div style="font-weight: bold; font-size: 14px; margin-bottom: 10px;">To:</div>
                            <div style="font-weight: bold;">[CUSTOMER_NAME]</div>
                            <div>[CUSTOMER_ADDRESS]</div>
                            <div>[CUSTOMER_POSTAL] [CUSTOMER_CITY]</div>
                        </div>
                    </div>

                    <!-- Invoice Details -->
                    <div style="margin-bottom: 30px;">
                        <div style="margin-bottom: 8px;"><strong>Invoice Number:</strong> [INVOICE_NUMBER]</div>
                        <div style="margin-bottom: 8px;"><strong>Invoice Date:</strong> [INVOICE_DATE]</div>
                        <div style="margin-bottom: 8px;"><strong>Due Date:</strong> [DUE_DATE]</div>
                        <div style="margin-bottom: 8px;"><strong>Customer ID:</strong> [CUSTOMER_ID]</div>
                    </div>

                    <!-- Line Items -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr>
                                <th style="border: 2px solid #000; padding: 12px; text-align: left; background: #f5f5f5;">Description</th>
                                <th style="border: 2px solid #000; padding: 12px; text-align: center; background: #f5f5f5;">Quantity</th>
                                <th style="border: 2px solid #000; padding: 12px; text-align: right; background: #f5f5f5;">Unit Price</th>
                                <th style="border: 2px solid #000; padding: 12px; text-align: right; background: #f5f5f5;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="border: 1px solid #000; padding: 12px;">[SAMPLE_ITEM]</td>
                                <td style="border: 1px solid #000; padding: 12px; text-align: center;">1</td>
                                <td style="border: 1px solid #000; padding: 12px; text-align: right;">$100.00</td>
                                <td style="border: 1px solid #000; padding: 12px; text-align: right;">$100.00</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Totals -->
                    <div style="text-align: right; margin-bottom: 40px;">
                        <div style="display: inline-block; text-align: left;">
                            <div style="margin-bottom: 8px;">Subtotal: <span style="margin-left: 50px;">$[SUBTOTAL]</span></div>
                            <div style="margin-bottom: 8px;">Tax (19%): <span style="margin-left: 50px;">$[TAX_AMOUNT]</span></div>
                            <div style="font-weight: bold; font-size: 16px; border-top: 2px solid #000; padding-top: 8px;">
                                Total: <span style="margin-left: 50px;">$[TOTAL_AMOUNT]</span>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="text-align: center; margin-top: 50px; font-size: 10px; border-top: 1px solid #000; padding-top: 20px;">
                        <div>Tax Number: [TAX_NUMBER] | VAT Number: [VAT_NUMBER]</div>
                        <div style="margin-top: 10px;">Thank you for your business!</div>
                    </div>
                </div>
            `;
        }

        function getMinimalistTemplate() {
            return `
                <div style="padding: 30mm; font-family: 'Inter', sans-serif; font-size: 12px; color: #333;">
                    <!-- Minimal Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 60px;">
                        <div style="color: #666;">
                            <div style="font-size: 14px;">[COMPANY_NAME]</div>
                            <div style="font-size: 10px;">[COMPANY_EMAIL]</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 36px; font-weight: 300; color: #333;">Invoice</div>
                            <div style="font-size: 14px; color: #666;">[INVOICE_NUMBER]</div>
                        </div>
                    </div>

                    <!-- Minimal Line -->
                    <div style="height: 1px; background: #eee; margin-bottom: 40px;"></div>

                    <!-- Clean Details -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 40px;">
                        <div>
                            <div style="font-size: 10px; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">Bill To</div>
                            <div style="font-weight: 500;">[CUSTOMER_NAME]</div>
                            <div style="color: #666; font-size: 11px;">[CUSTOMER_ADDRESS]</div>
                            <div style="color: #666; font-size: 11px;">[CUSTOMER_POSTAL] [CUSTOMER_CITY]</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 10px; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">Details</div>
                            <div style="margin-bottom: 3px;">Date: [INVOICE_DATE]</div>
                            <div style="margin-bottom: 3px;">Due: [DUE_DATE]</div>
                            <div>ID: [CUSTOMER_ID]</div>
                        </div>
                    </div>

                    <!-- Minimal Table -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 40px;">
                        <thead>
                            <tr style="border-bottom: 1px solid #eee;">
                                <th style="padding: 15px 0; text-align: left; font-weight: 400; color: #999; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Description</th>
                                <th style="padding: 15px 0; text-align: right; font-weight: 400; color: #999; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 20px 0; border-bottom: 1px solid #f5f5f5;">[SAMPLE_ITEM]</td>
                                <td style="padding: 20px 0; text-align: right; border-bottom: 1px solid #f5f5f5;">€100.00</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Minimal Total -->
                    <div style="text-align: right; margin-bottom: 60px;">
                        <div style="font-size: 24px; font-weight: 500;">€[TOTAL_AMOUNT]</div>
                        <div style="font-size: 10px; color: #999; text-transform: uppercase; letter-spacing: 1px;">Total Amount</div>
                    </div>

                    <!-- Simple Footer -->
                    <div style="text-align: center; font-size: 10px; color: #999; border-top: 1px solid #eee; padding-top: 30px;">
                        <div>[TAX_NUMBER] • [VAT_NUMBER]</div>
                    </div>
                </div>
            `;
        }

        function getCreativeColoredTemplate() {
            return `
                <div style="font-family: 'Inter', sans-serif; font-size: 12px; position: relative; overflow: hidden;">
                    <!-- Colored Header -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 80px; margin: -1px -1px 30px -1px; position: relative;">
                        <div style="position: absolute; bottom: 15px; left: 30px; color: white;">
                            <div style="font-size: 24px; font-weight: bold;">INVOICE</div>
                            <div style="opacity: 0.9;">[INVOICE_NUMBER]</div>
                        </div>
                        <div style="position: absolute; bottom: 15px; right: 30px; color: white; text-align: right;">
                            <div style="font-weight: bold;">[COMPANY_NAME]</div>
                            <div style="opacity: 0.9; font-size: 11px;">[COMPANY_EMAIL]</div>
                        </div>
                    </div>

                    <div style="padding: 0 30px;">
                        <!-- Customer Section with Color -->
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; margin-bottom: 30px; border-radius: 12px; border-left: 4px solid #667eea;">
                            <div style="color: #667eea; font-weight: bold; margin-bottom: 10px;">Bill To</div>
                            <div style="font-weight: bold; color: #333;">[CUSTOMER_NAME]</div>
                            <div style="color: #666;">[CUSTOMER_ADDRESS]</div>
                            <div style="color: #666;">[CUSTOMER_POSTAL] [CUSTOMER_CITY]</div>
                        </div>

                        <!-- Invoice Details with Accent -->
                        <div style="display: flex; gap: 20px; margin-bottom: 30px;">
                            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <div style="color: #667eea; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">Date</div>
                                <div>[INVOICE_DATE]</div>
                            </div>
                            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <div style="color: #667eea; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">Due Date</div>
                                <div>[DUE_DATE]</div>
                            </div>
                            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <div style="color: #667eea; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;">Customer ID</div>
                                <div>[CUSTOMER_ID]</div>
                            </div>
                        </div>

                        <!-- Modern Table -->
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                                    <th style="padding: 20px; text-align: left; font-weight: 500;">Item</th>
                                    <th style="padding: 20px; text-align: center; font-weight: 500;">Qty</th>
                                    <th style="padding: 20px; text-align: right; font-weight: 500;">Price</th>
                                    <th style="padding: 20px; text-align: right; font-weight: 500;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: #fafbfc;">
                                    <td style="padding: 20px; border-bottom: 1px solid #eee;">[SAMPLE_ITEM]</td>
                                    <td style="padding: 20px; text-align: center; border-bottom: 1px solid #eee;">1</td>
                                    <td style="padding: 20px; text-align: right; border-bottom: 1px solid #eee;">€100.00</td>
                                    <td style="padding: 20px; text-align: right; border-bottom: 1px solid #eee; font-weight: bold;">€100.00</td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Colorful Total -->
                        <div style="text-align: right; margin-bottom: 40px;">
                            <div style="display: inline-block; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px 30px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Total Amount</div>
                                <div style="font-size: 28px; font-weight: bold;">€[TOTAL_AMOUNT]</div>
                            </div>
                        </div>

                        <!-- Footer with Gradient Accent -->
                        <div style="text-align: center; margin-top: 50px; padding-top: 20px; border-top: 1px solid #eee; font-size: 10px; color: #666;">
                            <div style="margin-bottom: 10px;">
                                <span style="color: #667eea;">Tax ID:</span> [TAX_NUMBER] • 
                                <span style="color: #667eea;">VAT ID:</span> [VAT_NUMBER]
                            </div>
                            <div>Thank you for choosing [COMPANY_NAME]!</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function addInteractivityToElements() {
            // Add event listeners for drag and drop functionality
            const elements = document.querySelectorAll('#templateContent div, #templateContent table, #templateContent h1');
            elements.forEach(element => {
                element.style.position = 'relative';
                element.addEventListener('mousedown', startDrag);
                element.addEventListener('click', selectElement);
            });
        }

        function startDrag(e) {
            if (e.target.classList.contains('resize-handle')) return;
            
            dragElement = e.currentTarget;
            const rect = dragElement.getBoundingClientRect();
            const containerRect = document.getElementById('invoicePreview').getBoundingClientRect();
            
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            
            e.preventDefault();
        }

        function drag(e) {
            if (!dragElement) return;
            
            const containerRect = document.getElementById('invoicePreview').getBoundingClientRect();
            const x = (e.clientX - containerRect.left - dragOffset.x) / currentZoom;
            const y = (e.clientY - containerRect.top - dragOffset.y) / currentZoom;
            
            dragElement.style.position = 'absolute';
            dragElement.style.left = Math.max(0, x) + 'px';
            dragElement.style.top = Math.max(0, y) + 'px';
        }

        function stopDrag() {
            dragElement = null;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
        }

        function selectElement(e) {
            // Remove previous selection
            if (selectedElement) {
                selectedElement.classList.remove('selected');
            }
            
            selectedElement = e.currentTarget;
            selectedElement.classList.add('selected');
            
            // Show element properties panel
            showElementProperties();
            
            e.stopPropagation();
        }

        function showElementProperties() {
            const propsPanel = document.getElementById('elementProperties');
            propsPanel.style.display = 'block';
            
            if (selectedElement) {
                const rect = selectedElement.getBoundingClientRect();
                const containerRect = document.getElementById('invoicePreview').getBoundingClientRect();
                
                document.getElementById('elementX').value = Math.round((rect.left - containerRect.left) / currentZoom);
                document.getElementById('elementY').value = Math.round((rect.top - containerRect.top) / currentZoom);
                document.getElementById('elementWidth').value = Math.round(rect.width / currentZoom);
                document.getElementById('elementHeight').value = Math.round(rect.height / currentZoom);
                
                const computedStyle = window.getComputedStyle(selectedElement);
                document.getElementById('elementFontSize').value = parseInt(computedStyle.fontSize);
                document.getElementById('elementTextColor').value = rgbToHex(computedStyle.color);
            }
        }

        function applyElementProperties() {
            if (!selectedElement) return;
            
            const x = document.getElementById('elementX').value;
            const y = document.getElementById('elementY').value;
            const width = document.getElementById('elementWidth').value;
            const height = document.getElementById('elementHeight').value;
            const fontSize = document.getElementById('elementFontSize').value;
            const textColor = document.getElementById('elementTextColor').value;
            
            if (x) selectedElement.style.left = x + 'px';
            if (y) selectedElement.style.top = y + 'px';
            if (width) selectedElement.style.width = width + 'px';
            if (height) selectedElement.style.height = height + 'px';
            if (fontSize) selectedElement.style.fontSize = fontSize + 'px';
            if (textColor) selectedElement.style.color = textColor;
            
            selectedElement.style.position = 'absolute';
        }

        function deleteSelectedElement() {
            if (selectedElement) {
                selectedElement.remove();
                selectedElement = null;
                document.getElementById('elementProperties').style.display = 'none';
            }
        }

        function addElement(type) {
            let element;
            
            switch(type) {
                case 'text':
                    element = document.createElement('div');
                    element.innerHTML = 'Click to edit text';
                    element.style.padding = '10px';
                    element.style.border = '1px dashed #ccc';
                    break;
                case 'table':
                    element = document.createElement('table');
                    element.innerHTML = `
                        <tr>
                            <th style="border: 1px solid #000; padding: 8px;">Header 1</th>
                            <th style="border: 1px solid #000; padding: 8px;">Header 2</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 8px;">Cell 1</td>
                            <td style="border: 1px solid #000; padding: 8px;">Cell 2</td>
                        </tr>
                    `;
                    element.style.borderCollapse = 'collapse';
                    break;
                case 'line':
                    element = document.createElement('hr');
                    element.style.border = '1px solid #000';
                    element.style.width = '100%';
                    break;
                case 'image':
                    element = document.createElement('div');
                    element.innerHTML = '<i class="bi bi-image" style="font-size: 48px; color: #ccc;"></i>';
                    element.style.width = '100px';
                    element.style.height = '100px';
                    element.style.border = '2px dashed #ccc';
                    element.style.display = 'flex';
                    element.style.alignItems = 'center';
                    element.style.justifyContent = 'center';
                    break;
                case 'qr-code':
                    element = document.createElement('div');
                    element.innerHTML = '⊞ QR';
                    element.style.width = '80px';
                    element.style.height = '80px';
                    element.style.border = '1px solid #000';
                    element.style.display = 'flex';
                    element.style.alignItems = 'center';
                    element.style.justifyContent = 'center';
                    element.style.fontFamily = 'monospace';
                    break;
                case 'barcode':
                    element = document.createElement('div');
                    element.innerHTML = '||||| ||||| |||||';
                    element.style.width = '120px';
                    element.style.height = '40px';
                    element.style.border = '1px solid #000';
                    element.style.display = 'flex';
                    element.style.alignItems = 'center';
                    element.style.justifyContent = 'center';
                    element.style.fontFamily = 'monospace';
                    element.style.letterSpacing = '2px';
                    break;
            }
            
            if (element) {
                element.style.position = 'absolute';
                element.style.left = '50px';
                element.style.top = '50px';
                element.style.cursor = 'move';
                element.addEventListener('mousedown', startDrag);
                element.addEventListener('click', selectElement);
                
                document.getElementById('templateContent').appendChild(element);
            }
        }

        function updatePreview() {
            // Apply design settings to preview
            const preview = document.getElementById('templateContent');
            const primaryFont = document.getElementById('primaryFont').value;
            const headerFontSize = document.getElementById('headerFontSize').value;
            const bodyFontSize = document.getElementById('bodyFontSize').value;
            const primaryColor = document.getElementById('primaryColor').value;
            const textColor = document.getElementById('textColor').value;
            const backgroundColor = document.getElementById('backgroundColor').value;
            const pageMargins = document.getElementById('pageMargins').value;
            
            // Apply styles
            preview.style.fontFamily = primaryFont;
            preview.style.color = textColor;
            preview.style.backgroundColor = backgroundColor;
            preview.style.padding = pageMargins + 'mm';
            
            // Update headers
            const headers = preview.querySelectorAll('h1, h2, h3');
            headers.forEach(header => {
                header.style.fontSize = headerFontSize + 'px';
                header.style.color = primaryColor;
            });
            
            // Update body text
            const bodyElements = preview.querySelectorAll('div, td, p');
            bodyElements.forEach(el => {
                if (!el.style.fontSize) {
                    el.style.fontSize = bodyFontSize + 'px';
                }
            });
        }

        function adjustZoom(zoom) {
            currentZoom = zoom;
            const preview = document.getElementById('invoicePreview');
            preview.style.transform = `scale(${zoom})`;
            preview.style.transformOrigin = 'top center';
        }

        function toggleGrid() {
            const preview = document.getElementById('invoicePreview');
            if (preview.style.backgroundImage) {
                preview.style.backgroundImage = '';
            } else {
                preview.style.backgroundImage = `
                    linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
                    linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px)
                `;
                preview.style.backgroundSize = '20px 20px';
            }
        }

        function handleLogoUpload(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Create logo element
                    const logo = document.createElement('img');
                    logo.src = e.target.result;
                    logo.style.maxHeight = '60px';
                    logo.style.position = 'absolute';
                    logo.style.top = '20px';
                    logo.style.left = '20px';
                    logo.style.cursor = 'move';
                    
                    // Add interactivity
                    logo.addEventListener('mousedown', startDrag);
                    logo.addEventListener('click', selectElement);
                    
                    // Add to template
                    document.getElementById('templateContent').appendChild(logo);
                };
                reader.readAsDataURL(file);
            }
        }

        function previewTemplate() {
            // Open preview in new window
            const content = document.getElementById('templateContent').innerHTML;
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice Preview</title>
                    <style>
                        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
                        .preview { width: 210mm; min-height: 297mm; margin: 0 auto; background: white; }
                    </style>
                </head>
                <body>
                    <div class="preview">${content}</div>
                </body>
                </html>
            `);
        }

        function saveTemplate() {
            const name = document.getElementById('templateName').value.trim();
            const description = document.getElementById('templateDescription').value.trim();
            let content = document.getElementById('templateContent').innerHTML;
            
            if (!name) {
                alert('Please enter a template name');
                return;
            }
            
            if (!content) {
                alert('Please design a template first');
                return;
            }
            
            // Convert placeholders to Go template variables
            content = content.replace(/\[COMPANY_NAME\]/g, '{{.company.CompanyName}}');
            content = content.replace(/\[COMPANY_ADDRESS\]/g, '{{.company.AddressLine1}}');
            content = content.replace(/\[COMPANY_POSTAL\]/g, '{{.company.PostalCode}}');
            content = content.replace(/\[COMPANY_CITY\]/g, '{{.company.City}}');
            content = content.replace(/\[COMPANY_PHONE\]/g, '{{.company.Phone}}');
            content = content.replace(/\[COMPANY_EMAIL\]/g, '{{.company.Email}}');
            content = content.replace(/\[CUSTOMER_NAME\]/g, '{{.customer.GetDisplayName}}');
            content = content.replace(/\[CUSTOMER_ADDRESS\]/g, '{{.customer.AddressLine1}}');
            content = content.replace(/\[CUSTOMER_POSTAL\]/g, '{{.customer.PostalCode}}');
            content = content.replace(/\[CUSTOMER_CITY\]/g, '{{.customer.City}}');
            content = content.replace(/\[CUSTOMER_ID\]/g, '{{.customer.CustomerID}}');
            content = content.replace(/\[INVOICE_NUMBER\]/g, '{{.invoice.InvoiceNumber}}');
            content = content.replace(/\[INVOICE_DATE\]/g, '{{.invoice.IssueDate}}');
            content = content.replace(/\[DUE_DATE\]/g, '{{.invoice.DueDate}}');
            content = content.replace(/\[SUBTOTAL\]/g, '{{printf "%.2f" .invoice.Subtotal}}');
            content = content.replace(/\[TAX_AMOUNT\]/g, '{{printf "%.2f" .invoice.TaxAmount}}');
            content = content.replace(/\[TOTAL_AMOUNT\]/g, '{{printf "%.2f" .invoice.TotalAmount}}');
            content = content.replace(/\[TAX_NUMBER\]/g, '{{.company.TaxNumber}}');
            content = content.replace(/\[VAT_NUMBER\]/g, '{{.company.VATNumber}}');
            content = content.replace(/\[SAMPLE_ITEM\]/g, '{{range .invoice.LineItems}}{{.Description}}{{end}}');
            
            // Collect design settings
            const designSettings = {
                primaryFont: document.getElementById('primaryFont').value,
                headerFontSize: document.getElementById('headerFontSize').value,
                bodyFontSize: document.getElementById('bodyFontSize').value,
                primaryColor: document.getElementById('primaryColor').value,
                accentColor: document.getElementById('accentColor').value,
                textColor: document.getElementById('textColor').value,
                backgroundColor: document.getElementById('backgroundColor').value,
                pageMargins: document.getElementById('pageMargins').value,
                elementSpacing: document.getElementById('elementSpacing').value,
                borderStyle: document.getElementById('borderStyle').value,
                logoPosition: document.getElementById('logoPosition').value,
                logoSize: document.getElementById('logoSize').value,
                templateType: currentTemplate
            };
            
            const templateData = {
                name: name,
                description: description,
                htmlTemplate: content,
                cssStyles: JSON.stringify(designSettings),
                isDefault: false,
                isActive: true
            };
            
            const url = isEdit ? '/invoice-templates/' + templateID : '/invoice-templates';
            const method = isEdit ? 'PUT' : 'POST';
            
            // Show loading state
            const saveBtn = event.target;
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
            saveBtn.disabled = true;
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(templateData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success || data.message || data.templateId) {
                    alert('Template saved successfully!');
                    console.log('Save successful, navigating to:', '/invoice-templates');
                    console.log('Current location before navigation:', window.location.href);
                    // Ensure we navigate back to the template list
                    setTimeout(() => {
                        console.log('Executing navigation to /invoice-templates...');
                        console.log('About to set window.location.href to:', '/invoice-templates');
                        window.location.href = '/invoice-templates';
                        console.log('Navigation command executed');
                    }, 500);
                } else {
                    alert(data.error || 'Failed to save template');
                }
            })
            .catch(error => {
                console.error('Error saving template:', error);
                alert('Failed to save template: ' + error.message);
            })
            .finally(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }

        // Utility functions
        function rgbToHex(rgb) {
            const result = rgb.match(/\d+/g);
            if (result) {
                return '#' + result.map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
            }
            return '#000000';
        }

        // Click outside to deselect
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#templateContent') && !e.target.closest('#elementProperties')) {
                if (selectedElement) {
                    selectedElement.classList.remove('selected');
                    selectedElement = null;
                    document.getElementById('elementProperties').style.display = 'none';
                }
            }
        });

        // Navigation helper function
        function navigateToTemplates() {
            console.log('=== NAVIGATION DEBUGGING ===');
            console.log('navigateToTemplates() called');
            console.log('Current location:', window.location.href);
            console.log('Target URL: /invoice-templates');
            console.log('About to navigate...');
            
            try {
                // Force navigation to templates list
                window.location.href = '/invoice-templates';
                console.log('Navigation command executed successfully');
            } catch (error) {
                console.error('Navigation error:', error);
                console.log('Trying fallback navigation...');
                // Fallback navigation
                window.location = '/invoice-templates';
            }
        }

        // Test navigation function
        function testNavigation() {
            console.log('=== ROUTE TEST ===');
            console.log('Current URL:', window.location.href);
            console.log('Testing route: /invoice-templates');
            
            // Test fetch to see if the route exists and where it goes
            fetch('/invoice-templates', {
                method: 'GET',
                headers: {
                    'Accept': 'text/html',
                },
                redirect: 'follow'
            })
            .then(response => {
                console.log('Route test - Status:', response.status);
                console.log('Route test - Final URL:', response.url);
                console.log('Route test - Response type:', response.type);
                
                return response.text().then(html => {
                    console.log('Response HTML length:', html.length);
                    
                    // Check what page we actually got
                    if (html.includes('🔍 DEBUG: INVOICE TEMPLATES LIST PAGE 🔍')) {
                        alert('✅ SUCCESS: Got invoice templates page!');
                    } else if (html.includes('No jobs found')) {
                        alert('❌ ERROR: Got jobs page instead of templates page!');
                        console.log('Got jobs page HTML snippet:', html.substring(0, 500));
                    } else if (html.includes('Templates')) {
                        alert('⚠️ WARNING: Got some templates page, but not the expected one');
                        console.log('HTML snippet:', html.substring(0, 500));
                    } else {
                        alert('❓ UNKNOWN: Got unexpected page');
                        console.log('HTML snippet:', html.substring(0, 500));
                    }
                });
            })
            .catch(error => {
                console.error('Route test error:', error);
                alert('Route test error: ' + error.message);
            });
        }
    </script>
</body>
</html>