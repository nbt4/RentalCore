{{template "base.html" .}}

{{define "monitoring-dashboard-content"}}
<div class="container-fluid">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">
                    <i class="bi bi-speedometer2"></i> System Monitoring Dashboard
                </h2>
                <div>
                    <button class="btn btn-outline-primary" onclick="refreshDashboard()" aria-label="Dashboard aktualisieren">
                        <i class="bi bi-arrow-clockwise"></i> Aktualisieren
                    </button>
                    <button class="btn btn-outline-warning" onclick="triggerTestError()" aria-label="Test-Fehler erstellen">
                        <i class="bi bi-bug"></i> Test Error
                    </button>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-download"></i> Export
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/monitoring/metrics/prometheus" target="_blank">
                                <i class="bi bi-code"></i> Prometheus Format
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportMetricsJSON()">
                                <i class="bi bi-filetype-json"></i> JSON Format
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <p class="text-muted mt-2">Echtzeit-System- und Anwendungsmetriken</p>
        </div>
    </div>

    <!-- Status Overview Cards -->
    <div class="row mb-4" id="statusCards">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">System Status</h6>
                            <h4 id="systemStatus" class="mb-0">Loading...</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-server" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Requests Total</h6>
                            <h4 id="requestCount" class="mb-0">0</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-graph-up-arrow" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Error Rate</h6>
                            <h4 id="errorRate" class="mb-0">0%</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Memory Usage</h6>
                            <h4 id="memoryUsage" class="mb-0">0 MB</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-memory" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <div class="row">
        <!-- Performance Metrics -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-speedometer"></i> Performance Metriken
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>System Information</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Uptime:</strong></td><td id="uptime">-</td></tr>
                                <tr><td><strong>Goroutines:</strong></td><td id="goroutines">-</td></tr>
                                <tr><td><strong>CPU Cores:</strong></td><td id="cpuCores">-</td></tr>
                                <tr><td><strong>Go Version:</strong></td><td id="goVersion">-</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Performance</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Avg Response:</strong></td><td id="avgResponse">-</td></tr>
                                <tr><td><strong>Total Requests:</strong></td><td id="totalRequests">-</td></tr>
                                <tr><td><strong>Error Rate:</strong></td><td id="performanceErrorRate">-</td></tr>
                                <tr><td><strong>GC Runs:</strong></td><td id="gcRuns">-</td></tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slow Endpoints -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock"></i> Langsamste Endpoints
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="slowEndpointsTable">
                            <thead>
                                <tr>
                                    <th>Endpoint</th>
                                    <th>Avg Time</th>
                                    <th>Requests</th>
                                    <th>Error Rate</th>
                                    <th>Slow Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" class="text-center text-muted">Lade Daten...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Health & Errors -->
        <div class="col-lg-4">
            <!-- Database Stats -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-database"></i> Database Status
                    </h5>
                </div>
                <div class="card-body">
                    <div id="databaseStats">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cache Stats -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning"></i> Cache Status
                    </h5>
                </div>
                <div class="card-body">
                    <div id="cacheStats">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Errors -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bug"></i> Aktuelle Fehler
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewAllErrors()">
                        Alle anzeigen
                    </button>
                </div>
                <div class="card-body">
                    <div id="recentErrors">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Error Details Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Fehlerdetails</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="errorDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                <button type="button" class="btn btn-success" id="resolveErrorBtn" onclick="resolveError()">
                    <i class="bi bi-check"></i> Als gelöst markieren
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentErrorFingerprint = null;
let refreshInterval = null;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    startAutoRefresh();
});

// Auto-refresh every 30 seconds
function startAutoRefresh() {
    refreshInterval = setInterval(loadDashboardData, 30000);
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
}

// Load all dashboard data
function loadDashboardData() {
    Promise.all([
        fetch('/monitoring/health').then(r => r.json()),
        fetch('/monitoring/metrics').then(r => r.json()),
        fetch('/monitoring/errors?limit=5').then(r => r.json())
    ]).then(([health, metrics, errors]) => {
        updateStatusCards(health, metrics);
        updatePerformanceMetrics(metrics);
        updateSlowEndpoints(metrics.endpoints || []);
        updateDatabaseStats(metrics.database);
        updateCacheStats(metrics.cache);
        updateRecentErrors(errors.errors || []);
    }).catch(error => {
        console.error('Failed to load dashboard data:', error);
        showToast('Fehler beim Laden der Dashboard-Daten', 'danger');
    });
}

// Update status cards
function updateStatusCards(health, metrics) {
    // System status
    const statusElement = document.getElementById('systemStatus');
    const statusCard = statusElement.closest('.card');
    
    if (health.status === 'healthy') {
        statusElement.textContent = 'Healthy';
        statusCard.className = 'card bg-success text-white';
    } else if (health.status === 'degraded') {
        statusElement.textContent = 'Degraded';
        statusCard.className = 'card bg-warning text-white';
    } else {
        statusElement.textContent = 'Unhealthy';
        statusCard.className = 'card bg-danger text-white';
    }

    // Request count
    document.getElementById('requestCount').textContent = 
        (metrics.performance?.request_count || 0).toLocaleString();

    // Error rate
    const errorRate = metrics.performance?.error_rate || 0;
    document.getElementById('errorRate').textContent = errorRate.toFixed(2) + '%';
    
    const errorCard = document.getElementById('errorRate').closest('.card');
    if (errorRate > 10) {
        errorCard.className = 'card bg-danger text-white';
    } else if (errorRate > 5) {
        errorCard.className = 'card bg-warning text-white';
    } else {
        errorCard.className = 'card bg-success text-white';
    }

    // Memory usage
    const memoryMB = parseInt((metrics.memory?.allocated || '0 B').replace(/[^0-9]/g, '')) / (1024 * 1024);
    document.getElementById('memoryUsage').textContent = memoryMB.toFixed(0) + ' MB';
}

// Update performance metrics
function updatePerformanceMetrics(metrics) {
    const system = metrics.system || {};
    const performance = metrics.performance || {};
    const memory = metrics.memory || {};

    document.getElementById('uptime').textContent = system.uptime || '-';
    document.getElementById('goroutines').textContent = system.goroutines || '-';
    document.getElementById('cpuCores').textContent = system.cpu_cores || '-';
    document.getElementById('goVersion').textContent = system.go_version || '-';
    
    document.getElementById('avgResponse').textContent = performance.average_response || '-';
    document.getElementById('totalRequests').textContent = (performance.request_count || 0).toLocaleString();
    document.getElementById('performanceErrorRate').textContent = (performance.error_rate || 0).toFixed(2) + '%';
    document.getElementById('gcRuns').textContent = memory.gc_runs || '-';
}

// Update slow endpoints table
function updateSlowEndpoints(endpoints) {
    const tbody = document.querySelector('#slowEndpointsTable tbody');
    
    if (!endpoints || endpoints.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Keine Daten verfügbar</td></tr>';
        return;
    }

    tbody.innerHTML = endpoints.map(endpoint => `
        <tr>
            <td><code>${endpoint.endpoint}</code></td>
            <td>${endpoint.average_time}</td>
            <td>${endpoint.count.toLocaleString()}</td>
            <td><span class="badge ${endpoint.error_rate > 5 ? 'bg-danger' : 'bg-success'}">${endpoint.error_rate.toFixed(1)}%</span></td>
            <td><span class="badge ${endpoint.slow_rate > 10 ? 'bg-warning' : 'bg-success'}">${endpoint.slow_rate.toFixed(1)}%</span></td>
        </tr>
    `).join('');
}

// Update database stats
function updateDatabaseStats(dbStats) {
    const container = document.getElementById('databaseStats');
    
    if (!dbStats || dbStats.error) {
        container.innerHTML = `<div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> ${dbStats?.error || 'Keine Datenbankstatistiken verfügbar'}
        </div>`;
        return;
    }

    container.innerHTML = `
        <div class="row">
            <div class="col-6"><strong>Max Conn:</strong></div>
            <div class="col-6">${dbStats.max_open_connections || '-'}</div>
            <div class="col-6"><strong>Open:</strong></div>
            <div class="col-6">${dbStats.open_connections || '-'}</div>
            <div class="col-6"><strong>In Use:</strong></div>
            <div class="col-6">${dbStats.in_use || '-'}</div>
            <div class="col-6"><strong>Idle:</strong></div>
            <div class="col-6">${dbStats.idle || '-'}</div>
        </div>
    `;
}

// Update cache stats
function updateCacheStats(cacheStats) {
    const container = document.getElementById('cacheStats');
    
    if (!cacheStats) {
        container.innerHTML = '<div class="text-muted">Keine Cache-Statistiken verfügbar</div>';
        return;
    }

    container.innerHTML = `
        <div class="accordion" id="cacheAccordion">
            ${Object.entries(cacheStats).map(([cacheName, stats], index) => `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#cache${index}">
                            ${cacheName.replace('_', ' ').toUpperCase()}
                        </button>
                    </h2>
                    <div id="cache${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                         data-bs-parent="#cacheAccordion">
                        <div class="accordion-body">
                            <small>
                                <div>Total: ${stats.total_items || 0}</div>
                                <div>Active: ${stats.active_items || 0}</div>
                                <div>Expired: ${stats.expired_items || 0}</div>
                            </small>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Update recent errors
function updateRecentErrors(errors) {
    const container = document.getElementById('recentErrors');
    
    if (!errors || errors.length === 0) {
        container.innerHTML = '<div class="text-success"><i class="bi bi-check-circle"></i> Keine aktuellen Fehler</div>';
        return;
    }

    container.innerHTML = errors.map(error => `
        <div class="border-bottom pb-2 mb-2">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h6 class="mb-1">${error.message}</h6>
                    <small class="text-muted">${error.component || 'System'} - ${new Date(error.last_seen).toLocaleString()}</small>
                    <div>
                        <span class="badge bg-${getSeverityColor(error.severity)}">${error.severity}</span>
                        <span class="badge bg-secondary">${error.count}x</span>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="showErrorDetails('${error.fingerprint}')">
                    <i class="bi bi-eye"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// Get severity color for badge
function getSeverityColor(severity) {
    switch (severity.toLowerCase()) {
        case 'critical': return 'danger';
        case 'high': return 'warning';
        case 'medium': return 'info';
        case 'low': return 'secondary';
        default: return 'secondary';
    }
}

// Show error details in modal
function showErrorDetails(fingerprint) {
    fetch(`/monitoring/errors?limit=100`)
        .then(r => r.json())
        .then(data => {
            const error = data.errors.find(e => e.fingerprint === fingerprint);
            if (error) {
                currentErrorFingerprint = fingerprint;
                
                document.getElementById('errorDetails').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Fehlerinformationen</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Message:</strong></td><td>${error.message}</td></tr>
                                <tr><td><strong>Severity:</strong></td><td><span class="badge bg-${getSeverityColor(error.severity)}">${error.severity}</span></td></tr>
                                <tr><td><strong>Component:</strong></td><td>${error.component || '-'}</td></tr>
                                <tr><td><strong>Count:</strong></td><td>${error.count}</td></tr>
                                <tr><td><strong>First Seen:</strong></td><td>${new Date(error.first_seen).toLocaleString()}</td></tr>
                                <tr><td><strong>Last Seen:</strong></td><td>${new Date(error.last_seen).toLocaleString()}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Request Details</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Method:</strong></td><td>${error.method || '-'}</td></tr>
                                <tr><td><strong>Path:</strong></td><td>${error.path || '-'}</td></tr>
                                <tr><td><strong>IP:</strong></td><td>${error.ip || '-'}</td></tr>
                                <tr><td><strong>User:</strong></td><td>${error.username || '-'}</td></tr>
                            </table>
                        </div>
                    </div>
                    ${error.error ? `
                        <div class="mt-3">
                            <h6>Error Details</h6>
                            <pre class="bg-light p-2 rounded"><code>${error.error}</code></pre>
                        </div>
                    ` : ''}
                    ${error.stack && error.stack.length > 0 ? `
                        <div class="mt-3">
                            <h6>Stack Trace</h6>
                            <pre class="bg-light p-2 rounded" style="max-height: 300px; overflow-y: auto;"><code>${error.stack.map(frame => 
                                `${frame.function} (${frame.file}:${frame.line})`
                            ).join('\n')}</code></pre>
                        </div>
                    ` : ''}
                `;

                const modal = new bootstrap.Modal(document.getElementById('errorModal'));
                modal.show();
            }
        })
        .catch(error => {
            console.error('Failed to load error details:', error);
            showToast('Fehler beim Laden der Fehlerdetails', 'danger');
        });
}

// Resolve error
function resolveError() {
    if (!currentErrorFingerprint) return;

    const button = document.getElementById('resolveErrorBtn');
    setButtonLoading(button, true);

    fetch(`/monitoring/errors/${currentErrorFingerprint}/resolve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Fehler als gelöst markiert', 'success');
            bootstrap.Modal.getInstance(document.getElementById('errorModal')).hide();
            loadDashboardData(); // Refresh data
        } else {
            showToast('Fehler beim Markieren als gelöst: ' + (data.error || 'Unbekannter Fehler'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error resolving error:', error);
        showToast('Fehler beim Markieren als gelöst', 'danger');
    })
    .finally(() => {
        setButtonLoading(button, false);
    });
}

// Manual refresh
function refreshDashboard() {
    showToast('Dashboard wird aktualisiert...', 'info', 1000);
    loadDashboardData();
}

// Trigger test error
function triggerTestError() {
    fetch('/monitoring/test-error?severity=medium', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Test-Fehler wurde erstellt', 'success');
            setTimeout(loadDashboardData, 1000); // Refresh after 1 second
        }
    })
    .catch(error => {
        console.error('Failed to trigger test error:', error);
        showToast('Fehler beim Erstellen des Test-Fehlers', 'danger');
    });
}

// Export metrics as JSON
function exportMetricsJSON() {
    fetch('/monitoring/metrics')
        .then(response => response.json())
        .then(data => {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `metrics-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('Failed to export metrics:', error);
            showToast('Fehler beim Exportieren der Metriken', 'danger');
        });
}

// View all errors (navigate to full error page)
function viewAllErrors() {
    window.open('/monitoring/errors?limit=100', '_blank');
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>

<style>
.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.accordion-button {
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
}

.accordion-body {
    padding: 0.75rem 1rem;
}

#slowEndpointsTable code {
    font-size: 0.8rem;
    background: rgba(0,0,0,0.1);
    padding: 2px 4px;
    border-radius: 3px;
}

pre code {
    font-size: 0.8rem;
    line-height: 1.2;
}
</style>
{{end}}