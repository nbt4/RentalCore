<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}} - RentalCore</title>
    <link rel="stylesheet" href="/static/css/rental-core-design.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="rc-navbar">
        <div class="rc-container">
            <div class="rc-navbar-content">
                <a href="/" class="rc-navbar-brand">
                    <i class="bi bi-gear-wide-connected"></i>
                    RentalCore
                </a>
                <ul class="rc-navbar-nav">
                    <li><a href="/jobs" class="rc-nav-link">Jobs</a></li>
                    <li><a href="/devices" class="rc-nav-link rc-nav-link-active">Devices</a></li>
                    <li><a href="/customers" class="rc-nav-link">Customers</a></li>
                    <li><a href="/cases" class="rc-nav-link">Cases</a></li>
                    {{if .user}}
                    <li><a href="/logout" class="rc-nav-link">Logout</a></li>
                    {{else}}
                    <li><a href="/login" class="rc-btn rc-btn-primary rc-btn-sm">Login</a></li>
                    {{end}}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="rc-container rc-mt-lg">
        <!-- Page Header -->
        <div class="rc-flex rc-flex-between rc-mb-xl">
            <div>
                <h1 class="rc-heading-2">Device Management</h1>
                <p class="rc-text">Manage your equipment devices</p>
            </div>
            <div class="rc-flex rc-flex-gap-sm">
                <a href="/devices?view=list" class="rc-btn rc-btn-outline rc-btn-sm">List</a>
                <a href="/devices?view=categorized" class="rc-btn rc-btn-outline rc-btn-sm">Categories</a>
                <a href="/devices/new" class="rc-btn rc-btn-primary rc-btn-sm">New Device</a>
            </div>
        </div>

        <!-- Search -->
        <div class="rc-card rc-mb-lg">
            <div class="rc-card-body">
                <form method="GET" action="/devices">
                    <input type="hidden" name="view" value="{{.viewType}}">
                    <div class="rc-flex rc-flex-gap-md">
                        <input type="text" class="rc-input" name="search" placeholder="Search devices..." value="{{.params.SearchTerm}}" style="flex: 1;">
                        <button type="submit" class="rc-btn rc-btn-primary">Search</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Devices Table -->
        <div class="rc-card">
            <div class="rc-card-body">
                {{if .devices}}
                <table class="rc-table">
                    <thead>
                        <tr>
                            <th>Device ID</th>
                            <th>Product</th>
                            {{if eq .viewType "categorized"}}<th>Category</th>{{end}}
                            <th>Serial Number</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .devices}}
                        <tr>
                            <td><code>{{.Device.DeviceID}}</code></td>
                            <td>{{if .Device.Product}}{{.Device.Product.Name}}{{else}}-{{end}}</td>
                            {{if eq $.viewType "categorized"}}
                            <td>
                                {{if and .Device.Product .Device.Product.Category}}
                                    {{.Device.Product.Category.Name}}
                                {{else}}
                                    Uncategorized
                                {{end}}
                            </td>
                            {{end}}
                            <td>{{derefString .Device.SerialNumber}}</td>
                            <td>
                                {{if eq .Device.Status "free"}}
                                    <span class="rc-badge rc-badge-success">Free</span>
                                {{else if eq .Device.Status "rented"}}
                                    <span class="rc-badge rc-badge-warning">Rented</span>
                                {{else if eq .Device.Status "maintenance"}}
                                    <span class="rc-badge rc-badge-danger">Maintenance</span>
                                {{else}}
                                    <span class="rc-badge rc-badge-secondary">{{.Device.Status}}</span>
                                {{end}}
                            </td>
                            <td>
                                <div class="rc-flex rc-flex-gap-xs">
                                    <button type="button" class="rc-btn rc-btn-outline rc-btn-sm" title="View Details" onclick="showDeviceDetails('{{.Device.DeviceID}}')">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <a href="/devices/{{.Device.DeviceID}}/edit" class="rc-btn rc-btn-outline rc-btn-sm" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a href="/devices/{{.Device.DeviceID}}/qr" class="rc-btn rc-btn-outline rc-btn-sm" title="QR" target="_blank">
                                        <i class="bi bi-qr-code"></i>
                                    </a>
                                    <button type="button" class="rc-btn rc-btn-outline rc-btn-sm" title="Delete" onclick="deleteDevice('{{.Device.DeviceID}}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
                {{else}}
                <div class="rc-text-center">
                    <h3>No devices found</h3>
                    <a href="/devices/new" class="rc-btn rc-btn-primary">Add Device</a>
                </div>
                {{end}}
            </div>
        </div>

        <!-- Pagination -->
        {{if .devices}}
        <div class="rc-flex rc-flex-between rc-mt-lg">
            <div class="rc-flex rc-flex-gap-sm">
                {{if gt .currentPage 1}}
                <a href="/devices?view={{.viewType}}&page={{add .currentPage -1}}{{if .params.SearchTerm}}&search={{.params.SearchTerm}}{{end}}" class="rc-btn rc-btn-outline rc-btn-sm">Previous</a>
                {{end}}
                <span class="rc-btn rc-btn-ghost rc-btn-sm">Page {{.currentPage}}</span>
                {{if .hasNextPage}}
                <a href="/devices?view={{.viewType}}&page={{add .currentPage 1}}{{if .params.SearchTerm}}&search={{.params.SearchTerm}}{{end}}" class="rc-btn rc-btn-outline rc-btn-sm">Next</a>
                {{end}}
            </div>
            <div class="rc-text-sm">{{len .devices}} devices</div>
        </div>
        {{end}}
    </main>

    <!-- Device Details Modal -->
    <div id="deviceDetailsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalDeviceTitle">Device Details</h2>
                <button type="button" class="modal-close" onclick="closeDeviceDetailsModal()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="modalLoadingSpinner" class="loading-spinner">
                    <i class="bi bi-arrow-clockwise spin"></i> Loading...
                </div>
                <div id="modalDeviceContent" style="display: none;">
                    <!-- Device basic info -->
                    <div class="device-info-section">
                        <h3>Geräteinformationen</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Geräte-ID:</label>
                                <span id="deviceID"></span>
                            </div>
                            <div class="info-item">
                                <label>Produkt:</label>
                                <span id="productName"></span>
                            </div>
                            <div class="info-item">
                                <label>Seriennummer:</label>
                                <span id="serialNumber"></span>
                            </div>
                            <div class="info-item">
                                <label>Status:</label>
                                <span id="deviceStatus"></span>
                            </div>
                            <div class="info-item">
                                <label>Preis/Tag:</label>
                                <span id="pricePerDay"></span>
                            </div>
                            <div class="info-item">
                                <label>Gewicht:</label>
                                <span id="weight"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Device statistics -->
                    <div class="device-stats-section">
                        <h3>Statistiken</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="bi bi-briefcase"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value" id="totalJobs">0</div>
                                    <div class="stat-label">Gesamte Einsätze</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="bi bi-currency-euro"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value" id="totalEarnings">€0.00</div>
                                    <div class="stat-label">Gesamteinnahmen</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="bi bi-calendar-day"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value" id="totalDaysRented">0</div>
                                    <div class="stat-label">Tage vermietet</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="bi bi-graph-up"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value" id="averageRentalDuration">0</div>
                                    <div class="stat-label">Ø Mietdauer (Tage)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Minimal JavaScript -->
    <script>
    window.deleteDevice = function(deviceID) {
        if (confirm('Delete device ' + deviceID + '?')) {
            fetch('/devices/' + deviceID, {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error deleting device');
            });
        }
    };

    window.showDeviceDetails = function(deviceID) {
        const modal = document.getElementById('deviceDetailsModal');
        const loadingSpinner = document.getElementById('modalLoadingSpinner');
        const content = document.getElementById('modalDeviceContent');
        
        // Show modal and loading spinner
        modal.style.display = 'flex';
        loadingSpinner.style.display = 'block';
        content.style.display = 'none';
        
        // Fetch device details
        fetch('/devices/' + deviceID + '/stats')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Populate device information
                document.getElementById('modalDeviceTitle').textContent = 'Device Details - ' + deviceID;
                document.getElementById('deviceID').textContent = data.device.deviceID;
                document.getElementById('productName').textContent = data.device.product ? data.device.product.name : 'N/A';
                document.getElementById('serialNumber').textContent = data.device.serialNumber || 'N/A';
                document.getElementById('deviceStatus').textContent = data.device.status || 'N/A';
                document.getElementById('pricePerDay').textContent = data.stats.pricePerDay ? '€' + data.stats.pricePerDay.toFixed(2) : 'N/A';
                document.getElementById('weight').textContent = data.stats.weight ? data.stats.weight.toFixed(2) + ' kg' : 'N/A';
                
                // Populate statistics
                document.getElementById('totalJobs').textContent = data.stats.totalJobs || '0';
                document.getElementById('totalEarnings').textContent = '€' + (data.stats.totalEarnings || 0).toFixed(2);
                document.getElementById('totalDaysRented').textContent = data.stats.totalDaysRented || '0';
                document.getElementById('averageRentalDuration').textContent = (data.stats.averageRentalDuration || 0).toFixed(1);
                
                // Hide loading spinner and show content
                loadingSpinner.style.display = 'none';
                content.style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching device details:', error);
                loadingSpinner.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Error loading device details';
            });
    };

    window.closeDeviceDetailsModal = function() {
        document.getElementById('deviceDetailsModal').style.display = 'none';
    };

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('deviceDetailsModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };
    </script>
</body>
</html>