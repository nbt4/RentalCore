<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}} - RentalCore</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/app.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-gear-wide-connected"></i> RentalCore
            </a>
            <div class="navbar-nav">
                <a class="nav-link" href="/jobs">Jobs</a>
                <a class="nav-link" href="/devices">Devices</a>
                <a class="nav-link" href="/customers">Customers</a>
                <a class="nav-link" href="/invoices">Invoices</a>
                <a class="nav-link" href="/invoice-templates">Templates</a>
                <a class="nav-link" href="/logout">Logout ({{.user.Username}})</a>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title">
                    {{if .isEdit}}Edit Invoice{{else}}New Invoice{{end}}
                </h3>
                <a href="/invoices" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Invoices
                </a>
            </div>
            
            <div class="card-body">
                <form id="invoiceForm">
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="customerId">Customer *</label>
                                <select id="customerId" name="customerId" class="form-control" required>
                                    <option value="">Select Customer</option>
                                    {{range .customers}}
                                    <option value="{{.CustomerID}}"{{if and $.invoice (eq $.invoice.CustomerID .CustomerID)}} selected{{end}}>
                                        {{if .CompanyName}}{{.CompanyName}}{{else}}{{if .FirstName}}{{.FirstName}} {{end}}{{if .LastName}}{{.LastName}}{{end}}{{end}}
                                        (ID: {{.CustomerID}})
                                    </option>
                                    {{end}}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="jobId">Job (Optional)</label>
                                <select id="jobId" name="jobId" class="form-control">
                                    <option value="">Select Job</option>
                                    {{range .jobs}}
                                    <option value="{{.JobID}}"{{if and $.invoice $.invoice.JobID (eq $.invoice.JobID .JobID)}} selected{{end}}>{{.Description}} - {{.CustomerName}}</option>
                                    {{end}}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="templateId">Invoice Template</label>
                                <select id="templateId" name="templateId" class="form-control">
                                    <option value="">Select Template (Optional)</option>
                                    {{range .templates}}
                                    <option value="{{.TemplateID}}"{{if and $.invoice $.invoice.TemplateID (eq $.invoice.TemplateID .TemplateID)}} selected{{else if and (not $.invoice) .IsDefault}} selected{{end}}>{{.Name}}{{if .IsDefault}} (Default){{end}}</option>
                                    {{end}}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="invoiceNumber">Invoice Number *</label>
                                <input type="text" id="invoiceNumber" name="invoiceNumber" class="form-control" 
                                       value="{{.invoice.InvoiceNumber}}" required>
                            </div>

                            <div class="form-group">
                                <label for="issueDate">Issue Date *</label>
                                <input type="date" id="issueDate" name="issueDate" class="form-control" 
                                       value="{{.defaultIssueDate}}" required>
                            </div>

                            <div class="form-group">
                                <label for="dueDate">Due Date *</label>
                                <input type="date" id="dueDate" name="dueDate" class="form-control" 
                                       value="{{.defaultDueDate}}" required>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="status">Status</label>
                                <select id="status" name="status" class="form-control">
                                    <option value="draft">Draft</option>
                                    <option value="sent">Sent</option>
                                    <option value="paid">Paid</option>
                                    <option value="overdue">Overdue</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="notes">Notes</label>
                                <textarea id="notes" name="notes" class="form-control" rows="3">{{.invoice.Notes}}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                {{if .isEdit}}Update Invoice{{else}}Create Invoice{{end}}
                            </button>
                            <button type="button" class="btn btn-info me-2" onclick="previewInvoice()">
                                <i class="bi bi-eye"></i> Preview
                            </button>
                            <a href="/invoices" class="btn btn-secondary">Cancel</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('invoiceForm');
            
            // Handle form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Collect form data
                const formData = {
                    customerId: parseInt(document.getElementById('customerId').value) || 0,
                    jobId: parseInt(document.getElementById('jobId').value) || null,
                    templateId: parseInt(document.getElementById('templateId').value) || null,
                    issueDate: document.getElementById('issueDate').value + 'T00:00:00Z',
                    dueDate: document.getElementById('dueDate').value + 'T00:00:00Z',
                    paymentTerms: "Net 30", // String value
                    taxRate: 0.19, // Default 19%
                    discountAmount: 0,
                    notes: document.getElementById('notes').value || null,
                    termsConditions: null,
                    lineItems: [
                        {
                            itemType: "custom",
                            description: "Standard charge",
                            quantity: 1,
                            unitPrice: 0.01
                        }
                    ] // Provide a default line item to satisfy validation
                };
                
                // Validate required fields
                if (!formData.customerId) {
                    alert('Please select a customer');
                    return;
                }
                
                if (!document.getElementById('invoiceNumber').value) {
                    alert('Please enter an invoice number');
                    return;
                }
                
                // Submit form
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Creating...';
                
                const url = {{if .isEdit}}'/api/invoices/{{.invoice.InvoiceID}}'{{else}}'/api/invoices'{{end}};
                const method = {{if .isEdit}}'PUT'{{else}}'POST'{{end}};
                
                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    alert({{if .isEdit}}'Invoice updated successfully!'{{else}}'Invoice created successfully!'{{end}});
                    window.location.href = '/invoices';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error: ' + error.message);
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                });
            });
        });

        function previewInvoice() {
            // Collect form data
            const formData = {
                customerId: document.getElementById('customerId').value,
                jobId: document.getElementById('jobId').value,
                invoiceNumber: document.getElementById('invoiceNumber').value,
                issueDate: document.getElementById('issueDate').value,
                dueDate: document.getElementById('dueDate').value,
                status: document.getElementById('status').value,
                notes: document.getElementById('notes').value
            };
            
            // Validate required fields
            if (!formData.customerId) {
                alert('Please select a customer before previewing');
                return;
            }
            
            if (!formData.invoiceNumber) {
                alert('Please enter an invoice number before previewing');
                return;
            }
            
            // Open preview in new window
            const previewUrl = '/invoices/preview?' + new URLSearchParams(formData).toString();
            window.open(previewUrl, '_blank', 'width=800,height=600,scrollbars=yes');
        }
    </script>
</body>
</html>