<!DOCTYPE html>
<html>
<head>
    <title>Device JavaScript Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Device JavaScript Execution Test</h1>
    <div id="results"></div>
    <div id="device-categories"></div>
    
    <script>
        // Simple test devices array based on the real data structure
        const availableDevices = [
            {
                deviceID: "ACC3001",
                status: "free",
                serialnumber: "",
                product: {
                    name: "Botex 321 PSA",
                    category: {
                        name: "Other"
                    },
                    subcategory: {
                        name: "Accessories"
                    }
                }
            },
            {
                deviceID: "CO21001",
                status: "free",
                serialnumber: "",
                product: {
                    name: "CO2 Bottle to Hose Connector",
                    category: {
                        name: "Effect"
                    },
                    subcategory: {
                        name: "CO2"
                    }
                }
            }
        ];

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            results.appendChild(div);
            console.log(message);
        }

        // Test the groupDevicesByCategory function
        function groupDevicesByCategory(devices) {
            log('Starting groupDevicesByCategory with ' + devices.length + ' devices');
            const grouped = {};
            
            devices.forEach((device, index) => {
                log('Processing device ' + (index + 1) + ': ' + device.deviceID);
                
                // Skip devices that are not free
                if (device.status !== 'free') {
                    log('  Skipping device (status: ' + device.status + ')', 'info');
                    return;
                }
                
                const categoryName = device.product?.category?.name || 'Other';
                const subcategoryName = device.product?.subcategory?.name || 'General';
                
                log('  Category: ' + categoryName + ', Subcategory: ' + subcategoryName);
                
                if (!grouped[categoryName]) {
                    grouped[categoryName] = {};
                    log('  Created new category: ' + categoryName);
                }
                if (!grouped[categoryName][subcategoryName]) {
                    grouped[categoryName][subcategoryName] = [];
                    log('  Created new subcategory: ' + subcategoryName);
                }
                
                grouped[categoryName][subcategoryName].push(device);
                log('  Added device to group');
            });
            
            log('Grouping complete. Found ' + Object.keys(grouped).length + ' categories');
            return grouped;
        }

        // Test the renderCategorizedDevices function
        function renderCategorizedDevices(grouped) {
            log('Starting renderCategorizedDevices');
            const container = document.getElementById('device-categories');
            let html = '';
            
            if (Object.keys(grouped).length === 0) {
                log('No grouped devices found - showing empty message', 'error');
                html = `
                    <div class="text-center py-4">
                        <h5>No Available Devices</h5>
                        <p>All devices are currently assigned or not available.</p>
                    </div>
                `;
            } else {
                log('Rendering ' + Object.keys(grouped).length + ' categories', 'success');
                Object.keys(grouped).forEach(categoryName => {
                    const category = grouped[categoryName];
                    const deviceCount = Object.values(category).reduce((total, subcategory) => total + subcategory.length, 0);
                    log('  Category "' + categoryName + '" has ' + deviceCount + ' devices');
                    
                    html += '<div><h3>' + categoryName + ' (' + deviceCount + ' devices)</h3>';
                    
                    Object.keys(category).forEach(subcategoryName => {
                        const subcategoryDevices = category[subcategoryName];
                        log('    Subcategory "' + subcategoryName + '" has ' + subcategoryDevices.length + ' devices');
                        
                        html += '<div><h4>' + subcategoryName + '</h4>';
                        subcategoryDevices.forEach(device => {
                            html += '<div>Device: ' + device.deviceID + ' (' + (device.product?.name || 'Unknown') + ')</div>';
                        });
                        html += '</div>';
                    });
                    
                    html += '</div>';
                });
            }
            
            container.innerHTML = html;
            log('Rendering complete');
        }

        // Run the test
        function runTest() {
            try {
                log('=== STARTING DEVICE RENDERING TEST ===', 'info');
                log('Available devices: ' + availableDevices.length, 'info');
                
                const grouped = groupDevicesByCategory(availableDevices);
                renderCategorizedDevices(grouped);
                
                log('=== TEST COMPLETED SUCCESSFULLY ===', 'success');
            } catch (error) {
                log('ERROR: ' + error.message, 'error');
                log('Stack: ' + error.stack, 'error');
            }
        }

        // Run test when page loads
        window.onload = runTest;
    </script>
</body>
</html>